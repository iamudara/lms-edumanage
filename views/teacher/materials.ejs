<!DOCTYPE html>
<html lang="en" data-theme="corporate">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= pageTitle %> - LMS EduManage</title>
  <link href="/css/output.css" rel="stylesheet">
  <link href="/css/custom.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <%- include('../shared/navbar') %>

  <div class="container mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs mb-6">
      <ul>
        <li><a href="/teacher/dashboard"><i class="fas fa-home mr-1"></i>Dashboard</a></li>
        <li><a href="/teacher/courses"><i class="fas fa-book mr-1"></i>Courses</a></li>
        <li><a href="/teacher/courses/<%= course.id %>"><%= course.code %></a></li>
        <li>Materials</li>
      </ul>
    </div>

    <!-- Page Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-base-content mb-2">
        <i class="fas fa-file-alt mr-2"></i>Course Materials
      </h1>
      <p class="text-base-content/70"><%= course.code %> - <%= course.title %></p>
    </div>

    <!-- Success/Error Messages -->
    <% if (success) { %>
      <div class="alert alert-success mb-6">
        <i class="fas fa-check-circle"></i>
        <span><%= success %></span>
      </div>
    <% } %>

    <% if (error) { %>
      <div class="alert alert-error mb-6">
        <i class="fas fa-exclamation-circle"></i>
        <span><%= error %></span>
      </div>
    <% } %>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Upload Form (1/3 width) -->
      <div class="lg:col-span-1">
        <div class="card bg-base-100 shadow-xl sticky top-4">
          <div class="card-body">
            <h2 class="card-title text-xl mb-4">
              <i class="fas fa-upload mr-2"></i>Upload Material
            </h2>

            <form action="/teacher/courses/<%= course.id %>/materials/upload" method="POST" enctype="multipart/form-data" id="uploadForm">
              <!-- Title -->
              <div class="form-control mb-4">
                <label class="label">
                  <span class="label-text font-semibold">
                    Title <span class="text-error">*</span>
                  </span>
                </label>
                <input 
                  type="text" 
                  name="title" 
                  placeholder="e.g., Week 1 Lecture Notes"
                  class="input input-bordered w-full"
                  required
                >
              </div>

              <!-- Description -->
              <div class="form-control mb-4">
                <label class="label">
                  <span class="label-text font-semibold">Description</span>
                </label>
                <textarea 
                  name="description" 
                  class="textarea textarea-bordered h-20"
                  placeholder="Optional description..."
                ></textarea>
              </div>

              <!-- Upload Method Selection -->
              <div class="form-control mb-4">
                <label class="label">
                  <span class="label-text font-semibold">Upload Method</span>
                </label>
                <div class="tabs tabs-boxed">
                  <a class="tab tab-active" id="fileTab" onclick="switchTab('file')">
                    <i class="fas fa-file-upload mr-1"></i>File Upload
                  </a>
                  <a class="tab" id="urlTab" onclick="switchTab('url')">
                    <i class="fas fa-link mr-1"></i>URL Link
                  </a>
                </div>
              </div>

              <!-- File Upload Section -->
              <div id="fileSection" class="form-control mb-4">
                <label class="label">
                  <span class="label-text font-semibold">
                    Select File <span class="text-error">*</span>
                  </span>
                </label>
                <input 
                  type="file" 
                  name="material" 
                  id="materialFile"
                  class="file-input file-input-bordered w-full"
                  accept=".pdf,.doc,.docx,.ppt,.pptx"
                >
                <label class="label">
                  <span class="label-text-alt text-base-content/60">
                    PDF, DOC, DOCX, PPT, PPTX (Max 10MB)
                  </span>
                </label>
              </div>

              <!-- URL Input Section (Hidden by default) -->
              <div id="urlSection" class="form-control mb-4 hidden">
                <label class="label">
                  <span class="label-text font-semibold">
                    Material URL <span class="text-error">*</span>
                  </span>
                </label>
                <input 
                  type="url" 
                  name="material_url" 
                  id="materialUrl"
                  placeholder="https://example.com/document.pdf"
                  class="input input-bordered w-full"
                >
                <label class="label">
                  <span class="label-text-alt text-base-content/60">
                    Enter a direct link to the material
                  </span>
                </label>
              </div>

              <!-- Submit Button -->
              <div class="card-actions justify-end pt-4 border-t">
                <button type="submit" class="btn btn-primary btn-block">
                  <i class="fas fa-upload mr-2"></i>Upload Material
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Materials List (2/3 width) -->
      <div class="lg:col-span-2">
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <h2 class="card-title text-2xl mb-4">
              <i class="fas fa-list mr-2"></i>Uploaded Materials
              <span class="badge badge-primary"><%= materials.length %></span>
            </h2>

            <% if (materials.length === 0) { %>
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <span>No materials uploaded yet. Use the form to add your first material.</span>
              </div>
            <% } else { %>
              <div class="space-y-3">
                <% materials.forEach(material => { 
                  // Get file extension from database (file_type column)
                  const fileExt = material.file_type || 'link';

                  // Icon based on file type
                  let icon = 'fas fa-link';
                  let iconColor = 'text-info';
                  
                  if (fileExt === 'pdf') {
                    icon = 'fas fa-file-pdf';
                    iconColor = 'text-error';
                  } else if (fileExt === 'doc' || fileExt === 'docx') {
                    icon = 'fas fa-file-word';
                    iconColor = 'text-primary';
                  } else if (fileExt === 'ppt' || fileExt === 'pptx') {
                    icon = 'fas fa-file-powerpoint';
                    iconColor = 'text-warning';
                  } else if (fileExt === 'txt') {
                    icon = 'fas fa-file-alt';
                    iconColor = 'text-accent';
                  } else if (fileExt === 'jpg' || fileExt === 'jpeg' || fileExt === 'png' || fileExt === 'gif' || fileExt === 'webp') {
                    icon = 'fas fa-file-image';
                    iconColor = 'text-success';
                  }
                %>
                  <div class="card bg-base-200 hover:shadow-md transition-shadow">
                    <div class="card-body p-4">
                      <div class="flex items-start gap-4">
                        <!-- File Icon -->
                        <div class="avatar placeholder">
                          <div class="bg-base-300 text-base-content rounded-lg w-16 h-16 flex items-center justify-center">
                            <i class="<%= icon %> <%= iconColor %> text-3xl"></i>
                          </div>
                        </div>

                        <!-- Material Info -->
                        <div class="flex-1 min-w-0">
                          <h3 class="font-bold text-lg mb-1"><%= material.title %></h3>
                          
                          <% if (material.description) { %>
                            <p class="text-sm text-base-content/70 mb-2"><%= material.description %></p>
                          <% } %>

                          <div class="flex flex-wrap gap-2 items-center text-xs">
                            <div class="badge badge-outline">
                              <i class="<%= icon %> mr-1"></i>
                              <%= fileExt.toUpperCase() %>
                            </div>
                            <div class="text-base-content/50">
                              <i class="far fa-clock mr-1"></i>
                              <% 
                                const uploadDate = material.created_at || material.createdAt;
                                const dateStr = uploadDate ? new Date(uploadDate).toLocaleDateString('en-US', {
                                  month: 'short',
                                  day: 'numeric',
                                  year: 'numeric'
                                }) : 'Unknown';
                              %>
                              Uploaded <%= dateStr %>
                            </div>
                          </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-col gap-2">
                          <a 
                            href="<%= material.file_url %>" 
                            target="_blank"
                            class="btn btn-sm btn-primary"
                          >
                            <i class="fas fa-external-link-alt mr-1"></i>Open
                          </a>
                          <button 
                            onclick="deleteMaterial(<%= material.id %>, '<%= material.title %>')"
                            class="btn btn-sm btn-error btn-outline"
                          >
                            <i class="fas fa-trash mr-1"></i>Delete
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                <% }) %>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Info Card -->
        <div class="card bg-base-200 shadow-xl mt-6">
          <div class="card-body">
            <h3 class="font-semibold mb-2">
              <i class="fas fa-info-circle mr-2 text-info"></i>Upload Guidelines
            </h3>
            <ul class="text-sm space-y-1 text-base-content/80">
              <li><i class="fas fa-check mr-2 text-success"></i>Supported formats: PDF, DOC, DOCX, PPT, PPTX, TXT, Images (JPG, PNG, GIF)</li>
              <li><i class="fas fa-check mr-2 text-success"></i>Maximum file size: 10MB</li>
              <li><i class="fas fa-check mr-2 text-success"></i>You can upload files or provide external URLs</li>
              <li><i class="fas fa-check mr-2 text-success"></i>All enrolled students can access these materials</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%- include('../shared/footer') %>

  <script>
    // Tab switching
    function switchTab(type) {
      const fileTab = document.getElementById('fileTab');
      const urlTab = document.getElementById('urlTab');
      const fileSection = document.getElementById('fileSection');
      const urlSection = document.getElementById('urlSection');
      const fileInput = document.getElementById('materialFile');
      const urlInput = document.getElementById('materialUrl');

      if (type === 'file') {
        fileTab.classList.add('tab-active');
        urlTab.classList.remove('tab-active');
        fileSection.classList.remove('hidden');
        urlSection.classList.add('hidden');
        fileInput.required = true;
        urlInput.required = false;
        urlInput.value = '';
      } else {
        urlTab.classList.add('tab-active');
        fileTab.classList.remove('tab-active');
        urlSection.classList.remove('hidden');
        fileSection.classList.add('hidden');
        urlInput.required = true;
        fileInput.required = false;
        fileInput.value = '';
      }
    }

    // Delete material function
    async function deleteMaterial(materialId, title) {
      if (!confirm(`Are you sure you want to delete "${title}"?`)) {
        return;
      }

      try {
        const response = await fetch(`/teacher/materials/${materialId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (data.success) {
          window.location.href = data.redirectUrl;
        } else {
          alert(data.message || 'Error deleting material');
        }
      } catch (error) {
        console.error('Delete error:', error);
        alert('Error deleting material. Please try again.');
      }
    }

    // Form validation
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
      const title = document.querySelector('input[name="title"]').value.trim();
      const fileInput = document.getElementById('materialFile');
      const urlInput = document.getElementById('materialUrl');

      if (!title) {
        e.preventDefault();
        alert('Please enter a title');
        return false;
      }

      const isFileTab = !document.getElementById('fileSection').classList.contains('hidden');
      
      if (isFileTab && !fileInput.files[0]) {
        e.preventDefault();
        alert('Please select a file to upload');
        return false;
      }

      if (!isFileTab && !urlInput.value.trim()) {
        e.preventDefault();
        alert('Please enter a URL');
        return false;
      }

      // Check file size
      if (isFileTab && fileInput.files[0]) {
        const fileSize = fileInput.files[0].size / 1024 / 1024; // Convert to MB
        if (fileSize > 10) {
          e.preventDefault();
          alert('File size exceeds 10MB limit');
          return false;
        }
      }
    });
  </script>
</body>
</html>
