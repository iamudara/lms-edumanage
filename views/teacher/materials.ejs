<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= pageTitle %> - LMS EduManage</title>
  <link href="/css/output.css" rel="stylesheet">
  <link href="/css/custom.css" rel="stylesheet">
  <link href="/css/teacher-theme.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .folder-tree { min-height: 400px; }
    .folder-item { 
      cursor: pointer; 
      padding: 6px 10px;
      border-radius: 4px;
      transition: all 0.15s;
      user-select: none;
    }
    .folder-item:hover { background-color: oklch(var(--b2)); }
    .folder-item.selected { 
      background-color: oklch(var(--p) / 0.15); 
      border-left: 3px solid oklch(var(--p));
      margin-left: -3px;
      font-weight: 600;
      color: oklch(var(--p));
      box-shadow: inset 0 0 0 1px oklch(var(--p) / 0.3);
    }
    .folder-item.selected .fa-folder,
    .folder-item.selected .fa-home { color: oklch(var(--p)); }
    .folder-item.not-shared { opacity: 0.6; }
    .folder-item.not-shared:hover { opacity: 1; }
    .folder-item .chevron { transition: transform 0.15s; }
    .folder-item.expanded .chevron { transform: rotate(90deg); }
    .folder-children { display: none; }
    .folder-item.expanded + .folder-children { display: block; }
    .material-item { transition: all 0.15s; }
    .material-item:hover { background-color: oklch(var(--b2)); }
    .empty-state { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      min-height: 300px;
      color: oklch(var(--bc) / 0.4);
    }
    .folder-actions { opacity: 0; transition: opacity 0.15s; }
    .folder-item:hover .folder-actions { opacity: 1; }
  </style>
</head>
<body>
  <%- include('../shared/navbar') %>

  <div class="container mx-auto px-3 sm:px-4 py-4 sm:py-8 max-w-7xl">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs mb-4 sm:mb-6">
      <ul>
        <li><a href="/teacher/dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
        <li><a href="/teacher/courses"><i class="fas fa-book"></i> Courses</a></li>
        <li><a href="/teacher/courses/<%= course.id %>"><i class="fas fa-graduation-cap"></i> <%= course.title %></a></li>
        <li><i class="fas fa-folder-open"></i> Materials</li>
      </ul>
    </div>

    <!-- Page Header -->
    <div class="mb-6 sm:mb-8">
      <h1 class="text-2xl sm:text-3xl font-bold mb-2">
        <i class="fas fa-folder-open mr-2"></i>Course Materials
      </h1>
      <p class="text-sm sm:text-base text-base-content/70"><%= course.code %> - <%= course.title %></p>
    </div>

    <!-- Messages -->
    <div id="alertContainer">
      <% if (success) { %>
        <div class="alert alert-success mb-4 py-2"><i class="fas fa-check-circle"></i><span><%= success %></span></div>
      <% } %>
      <% if (error) { %>
        <div class="alert alert-error mb-4 py-2"><i class="fas fa-exclamation-circle"></i><span><%= error %></span></div>
      <% } %>
    </div>

    <!-- Two Column Layout -->
    <div class="flex flex-col lg:flex-row gap-4" style="min-height: 500px;">
      
      <!-- Left: Folder Tree (Explorer) -->
      <div class="w-full lg:w-96 flex-shrink-0">
        <div class="card bg-base-100 shadow h-full">
          <div class="card-body p-3">
            <!-- Header -->
            <div class="flex items-center justify-between mb-2 pb-2 border-b">
              <span class="font-bold text-xs uppercase tracking-wide text-base-content/60">Explorer</span>
              <div class="flex gap-1">
                <button onclick="openCreateFolderModal(currentFolderId, currentFolderSharedCount)" class="btn btn-ghost btn-s" title="New Folder">
                  <i class="fas fa-folder-plus text-warning"></i>
                </button>
              </div>
            </div>

            <!-- Folder Tree -->
            <div class="folder-tree text-sm">
              <!-- Course Materials (Root) -->
              <div class="folder-item flex items-center gap-2 selected" 
                   data-folder-id="" 
                   onclick="selectFolder(this, '', 'Course Materials', <%= materials.length %>, 0)">
                <i class="fas fa-chevron-right chevron text-xs text-base-content/30 invisible"></i>
                <i class="fas fa-home text-primary text-sm"></i>
                <span class="flex-1">Course Materials</span>
                <span class="text-xs text-base-content/50"><%= materials.length %></span>
              </div>

              <!-- Folders -->
              <% 
              if (folderTree && folderTree.length > 0) { 
                function renderTree(folder, indent) {
                  var count = folder.materials ? folder.materials.length : 0;
                  var hasKids = folder.children && folder.children.length > 0;
                  var sharedCount = folder.sharedCourseCount || 0;
                  var isShared = sharedCount > 1; // Shared with more than 1 course
              %>
                <div class="folder-item flex items-center gap-2" 
                     style="padding-left: <%= indent %>px;"
                     data-folder-id="<%= folder.id %>"
                     data-shared-count="<%= sharedCount %>"
                     onclick="selectFolder(this, '<%= folder.id %>', '<%= folder.name.replace(/'/g, "\\'") %>', <%= count %>, <%= sharedCount %>)">
                  <% if (hasKids) { %>
                    <i class="fas fa-chevron-right chevron text-xs text-base-content/30" onclick="event.stopPropagation(); toggleExpand(this.parentElement)"></i>
                  <% } else { %>
                    <i class="fas fa-chevron-right chevron text-xs text-base-content/30 invisible"></i>
                  <% } %>
                  <% if (isShared) { %>
                    <i class="fas fa-folder text-success text-sm" title="Shared folder"></i>
                  <% } else { %>
                    <i class="fas fa-folder text-warning text-sm"></i>
                  <% } %>
                  <span class="flex-1 truncate"><%= folder.name %></span>
                  <% if (isShared) { %>
                    <span class="badge badge-success badge-xs" title="Shared with <%= sharedCount %> courses"><%= sharedCount %></span>
                  <% } %>
                  <span class="text-xs text-base-content/50"><%= count %></span>
                  <div class="folder-actions flex gap-0.5">
                    <button onclick="event.stopPropagation(); openCreateFolderModal('<%= folder.id %>', <%= sharedCount %>)" class="btn btn-ghost btn-xs px-1" title="Add Subfolder">
                      <i class="fas fa-plus text-success text-xs"></i>
                    </button>
                    <button onclick="event.stopPropagation(); openRenameModal('<%= folder.id %>', '<%= folder.name.replace(/'/g, "\\'") %>', <%= sharedCount %>)" class="btn btn-ghost btn-xs px-1" title="Rename">
                      <i class="fas fa-pen text-info text-xs"></i>
                    </button>
                    <button onclick="event.stopPropagation(); deleteFolder('<%= folder.id %>', '<%= folder.name.replace(/'/g, "\\'") %>', <%= sharedCount %>)" class="btn btn-ghost btn-xs px-1" title="Delete">
                      <i class="fas fa-trash text-error text-xs"></i>
                    </button>
                  </div>
                </div>
                <% if (hasKids) { %>
                  <div class="folder-children" style="margin-left: <%= indent %>px;">
                    <% folder.children.forEach(function(child) { renderTree(child, 16); }); %>
                  </div>
                <% } %>
              <% 
                }
                folderTree.forEach(function(f) { renderTree(f, 16); });
              } %>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Materials Panel -->
      <div class="flex-1">
        <div class="card bg-base-100 shadow h-full">
          <div class="card-body p-3 sm:p-4">
            <!-- Header -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-4 pb-3 border-b">
              <div class="flex items-center gap-2 flex-wrap">
                <i class="fas fa-folder-open text-warning" id="folderIcon"></i>
                <h2 class="font-bold text-base sm:text-lg" id="folderTitle">Course Materials</h2>
                <span class="badge badge-primary badge-sm" id="countBadge"><%= materials.length %></span>
                <span id="sharedIndicator" class="badge badge-success badge-sm hidden">
                  <i class="fas fa-share-alt mr-1"></i>Shared
                </span>
              </div>
              <div class="flex gap-2 w-full sm:w-auto">
                <button id="shareFolderBtn" onclick="openShareModal()" class="btn btn-outline btn-secondary btn-sm hidden flex-1 sm:flex-none" style="padding-left: 1.5rem; padding-right: 1.5rem;">
                  <i class="fas fa-share-alt"></i>
                  <span class="hidden xs:inline ml-1">Share</span>
                </button>
                <button id="uploadBtn" onclick="openUploadModal()" class="btn btn-primary btn-sm flex-1 sm:flex-none" style="padding-left: 1.5rem; padding-right: 1.5rem;">
                  <i class="fas fa-upload"></i>
                  <span class="hidden xs:inline ml-1">Upload</span>
                </button>
              </div>
            </div>

            <!-- Materials Container -->
            <div id="materialsPanel">
              <!-- Root content -->
              <div id="content-root" class="folder-content">
                <div class="alert alert-info mb-4 py-2 text-sm">
                  <i class="fas fa-info-circle"></i>
                  <span>These are course-specific materials. IF you want to share materials between your courses in the future, create a folder and put materials in it, then use the <strong>Share</strong> button.</span>
                </div>
                <% if (materials.length === 0) { %>
                  <div class="empty-state">
                    <i class="fas fa-cloud-upload-alt text-6xl mb-4"></i>
                    <p class="font-medium text-lg">No materials yet</p>
                    <p class="text-sm mb-4">Upload your first material or create a folder</p>
                    <button onclick="openUploadModal()" class="btn btn-primary btn-sm" style="padding-left: 1.5rem; padding-right: 1.5rem;">
                      <i class="fas fa-upload mr-1"></i>Upload Material
                    </button>
                  </div>
                <% } else { %>
                  <div class="space-y-2">
                    <% materials.forEach(function(m) { 
                      var ext = m.file_type || 'link';
                      var ico = 'fas fa-link text-info';
                      var viewUrl = m.file_url;
                      var isOffice = ['ppt', 'pptx', 'doc', 'docx', 'xls', 'xlsx'].includes(ext.toLowerCase());
                      
                      if (isOffice) {
                        viewUrl = `https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(m.file_url)}`;
                      }

                      if (ext === 'pdf') ico = 'fas fa-file-pdf text-error';
                      else if (ext === 'doc' || ext === 'docx') ico = 'fas fa-file-word text-primary';
                      else if (ext === 'ppt' || ext === 'pptx') ico = 'fas fa-file-powerpoint text-warning';
                    %>
                      <div class="material-item flex items-center gap-2 sm:gap-3 p-2 sm:p-3 rounded-lg border">
                        <div class="w-8 h-8 sm:w-10 sm:h-10 rounded bg-base-200 flex items-center justify-center flex-shrink-0">
                          <i class="<%= ico %> text-base sm:text-lg"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                          <p class="font-medium text-sm sm:text-base truncate"><%= m.title %></p>
                          <p class="text-xs text-base-content/50"><%= ext.toUpperCase() %></p>
                        </div>
                        <a href="<%= viewUrl %>" target="_blank" class="btn btn-primary btn-xs sm:btn-sm min-w-[2rem] sm:min-w-[2.5rem]"><i class="fas fa-external-link-alt"></i></a>
                        <button onclick="deleteMaterial(this, <%= m.id %>, '<%= m.title.replace(/'/g, "\\'") %>')" class="btn btn-xs sm:btn-sm min-w-[2rem] sm:min-w-[2.5rem]" style="background-color: #ef4444; border-color: #ef4444; color: white;"><i class="fas fa-trash"></i></button>
                      </div>
                    <% }); %>
                  </div>
                <% } %>
              </div>

              <!-- Folder contents -->
              <% 
              function renderContent(folder) {
                var mats = folder.materials || [];
              %>
                <div id="content-<%= folder.id %>" class="folder-content hidden">
                  <% if (mats.length === 0) { %>
                    <div class="empty-state">
                      <i class="fas fa-cloud-upload-alt text-6xl mb-4"></i>
                      <p class="font-medium text-lg">No materials yet</p>
                      <p class="text-sm mb-4">Upload your first material to this folder</p>
                      <button onclick="openUploadModal()" class="btn btn-primary btn-sm" style="padding-left: 1.5rem; padding-right: 1.5rem;">
                        <i class="fas fa-upload mr-1"></i>Upload Material
                      </button>
                    </div>
                  <% } else { %>
                    <div class="space-y-2">
                      <% mats.forEach(function(m) { 
                        var ext = m.file_type || 'link';
                        var ico = 'fas fa-link text-info';
                        var viewUrl = m.file_url;
                        var isOffice = ['ppt', 'pptx', 'doc', 'docx', 'xls', 'xlsx'].includes(ext.toLowerCase());
                        
                        if (isOffice) {
                          viewUrl = `https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(m.file_url)}`;
                        }

                        if (ext === 'pdf') ico = 'fas fa-file-pdf text-error';
                        else if (ext === 'doc' || ext === 'docx') ico = 'fas fa-file-word text-primary';
                        else if (ext === 'ppt' || ext === 'pptx') ico = 'fas fa-file-powerpoint text-warning';
                      %>
                        <div class="material-item flex items-center gap-2 sm:gap-3 p-2 sm:p-3 rounded-lg border">
                          <div class="w-8 h-8 sm:w-10 sm:h-10 rounded bg-base-200 flex items-center justify-center flex-shrink-0">
                            <i class="<%= ico %> text-base sm:text-lg"></i>
                          </div>
                          <div class="flex-1 min-w-0">
                            <p class="font-medium text-sm sm:text-base truncate"><%= m.title %></p>
                            <p class="text-xs text-base-content/50"><%= ext.toUpperCase() %></p>
                          </div>
                          <a href="<%= viewUrl %>" target="_blank" class="btn btn-primary btn-xs sm:btn-sm min-w-[2rem] sm:min-w-[2.5rem]"><i class="fas fa-external-link-alt"></i></a>
                          <button onclick="deleteMaterial(this, <%= m.id %>, '<%= m.title.replace(/'/g, "\\'") %>')" class="btn btn-xs sm:btn-sm min-w-[2rem] sm:min-w-[2.5rem]" style="background-color: #ef4444; border-color: #ef4444; color: white;"><i class="fas fa-trash"></i></button>
                        </div>
                      <% }); %>
                    </div>
                  <% } %>
                </div>
              <% 
                if (folder.children) folder.children.forEach(renderContent);
              }
              if (folderTree) folderTree.forEach(renderContent);
              %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <dialog id="uploadModal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4"><i class="fas fa-upload text-primary mr-2"></i>Upload to: <span id="uploadTo">Course Materials</span></h3>
      <form action="/teacher/courses/<%= course.id %>/materials/upload" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="folder_id" id="uploadFolderId" value="">
        <div class="form-control mb-3">
          <label class="label py-1"><span class="label-text">Title <span class="text-error">*</span></span></label>
          <input type="text" name="title" class="input input-bordered input-sm" required>
        </div>
        <div class="form-control mb-3">
          <label class="label py-1"><span class="label-text">Description</span></label>
          <textarea name="description" class="textarea textarea-bordered textarea-sm" rows="2"></textarea>
        </div>
        <!-- Upload Method Tabs -->
        <div class="tabs tabs-boxed mb-4 bg-base-200">
          <a class="tab tab-active flex-1" id="tabUploadFile" onclick="switchUploadTab('file')"><i class="fas fa-file-upload mr-2"></i>Upload File</a>
          <a class="tab flex-1" id="tabShareLink" onclick="switchUploadTab('url')"><i class="fas fa-link mr-2"></i>Share Link</a>
        </div>

        <!-- File Upload Section -->
        <div id="fileUploadSection">
          <div class="form-control mb-3">
            <input type="file" name="material" id="materialFileInput" class="file-input file-input-bordered file-input-sm w-full">
            <label class="label">
              <span class="label-text-alt">Supported: PDF, DOC, PPT, ZIP, etc.</span>
            </label>
          </div>
        </div>

        <!-- URL Upload Section -->
        <div id="urlUploadSection" class="hidden">
          <div class="form-control mb-4">
            <input type="url" name="material_url" id="materialUrlInput" class="input input-bordered input-sm w-full" placeholder="https://example.com/resource">
            <label class="label">
              <span class="label-text-alt">Link to external resources</span>
            </label>
          </div>
        </div>
        
        <!-- Upload Progress Bar -->
        <div id="materialUploadProgress" class="hidden mb-4">
          <div class="flex justify-between text-sm mb-1">
            <span class="font-medium">Uploading...</span>
            <span id="materialUploadPercentage">0%</span>
          </div>
          <progress id="materialUploadProgressBar" class="progress progress-primary w-full" value="0" max="100"></progress>
          <div class="text-xs text-base-content opacity-60 mt-1">
            <span id="materialUploadedSize">0 MB</span> / <span id="materialTotalSize">0 MB</span>
          </div>
        </div>
        
        <div class="modal-action">
          <button type="button" class="btn btn-error btn-sm text-white" onclick="uploadModal.close()">Cancel</button>
          <button type="submit" class="btn btn-primary btn-sm" id="materialUploadBtn">Upload</button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Create Folder Modal -->
  <dialog id="createModal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4"><i class="fas fa-folder-plus text-warning mr-2"></i><span id="createTitle">New Folder</span></h3>
      <form action="/teacher/folders" method="POST">
        <input type="hidden" name="parent_id" id="parentId" value="">
        <input type="hidden" name="course_ids[]" value="<%= course.id %>">
        <input type="hidden" name="redirect" value="/teacher/courses/<%= course.id %>/materials">
        <div class="form-control mb-4">
          <label class="label py-1"><span class="label-text">Name <span class="text-error">*</span></span></label>
          <input type="text" name="name" class="input input-bordered input-sm" required>
        </div>
        <div class="modal-action">
          <button type="button" class="btn btn-primary btn-sm" onclick="createModal.close()">Cancel</button>
          <button type="submit" class="btn btn-warning btn-sm" onclick="this.disabled=true; this.innerHTML='<span class=\'loading loading-spinner loading-xs\'></span> Creating...'; this.form.submit();">Create</button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Rename Modal -->
  <dialog id="renameModal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4"><i class="fas fa-edit text-info mr-2"></i>Rename Folder</h3>
      <input type="hidden" id="renameId">
      <div class="form-control mb-3">
        <label class="label py-1"><span class="label-text">Name</span></label>
        <input type="text" id="renameName" class="input input-bordered input-sm" required>
      </div>
      <div class="modal-action">
        <button type="button" class="btn btn-primary btn-sm" onclick="renameModal.close()">Cancel</button>
        <button type="button" class="btn btn-info btn-sm" onclick="submitRename()">Save</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Share Modal -->
  <dialog id="shareModal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">
        <i class="fas fa-share-alt text-success mr-2"></i>Share Folder: <span id="shareFolderName"></span>
      </h3>
      <form id="shareForm">
        <input type="hidden" id="shareFolderId">
        <div class="form-control mb-4">
          <label class="label">
            <span class="label-text font-semibold">Select Courses to Share With</span>
          </label>
          <div class="space-y-2 max-h-60 overflow-y-auto border rounded-lg p-2" id="courseCheckboxes">
            <% if (typeof courses !== 'undefined' && courses.length > 0) { %>
              <% courses.forEach(c => { %>
                <label class="flex items-center gap-3 p-2 hover:bg-base-200 rounded cursor-pointer <%= c.id === course.id ? 'bg-primary/10 border border-primary/30' : '' %>">
                  <input type="checkbox" name="course_ids" value="<%= c.id %>" 
                         class="checkbox checkbox-primary checkbox-sm course-checkbox"
                         data-is-current="<%= c.id === course.id ? 'true' : 'false' %>">
                  <span class="text-sm">
                    <strong><%= c.code %></strong> - <%= c.title %>
                    <% if (c.id === course.id) { %>
                      <span class="badge badge-primary badge-xs ml-1">Current</span>
                    <% } %>
                  </span>
                </label>
              <% }) %>
            <% } else { %>
              <div class="alert alert-warning py-2">
                <i class="fas fa-exclamation-triangle"></i>
                <span>No courses available to share with.</span>
              </div>
            <% } %>
          </div>
        </div>
        <div class="alert alert-info py-2 text-sm mb-4">
          <i class="fas fa-info-circle"></i>
          <div>
            <p>Shared folders and their contents will be visible in the selected courses.</p>
            <p class="mt-1 text-warning font-semibold">⚠️ The current course must remain selected.</p>
          </div>
        </div>
        <div class="modal-action">
          <button type="button" class="btn btn-primary btn-sm" onclick="shareModal.close()">Cancel</button>
          <button type="button" class="btn btn-success btn-sm" onclick="submitShare()">
            <i class="fas fa-share-alt mr-1"></i>Share
          </button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Delete Confirmation Modal -->
  <dialog id="deleteModal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg text-error"><i class="fas fa-exclamation-triangle mr-2"></i>Delete Material</h3>
      <p class="py-4" id="deleteModalMessage">Are you sure you want to delete this material?</p>
      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-sm btn-primary">Cancel</button>
        </form>
        <button id="confirmDeleteBtn" class="btn btn-error btn-sm text-white">Delete</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <%- include('../shared/footer') %>

  <script>
    let currentFolderId = '';
    let currentFolderName = 'Root';
    let currentFolderSharedCount = 0; // Track how many courses share this folder
    const STORAGE_KEY = 'materials_expanded_<%= course.id %>';

    // Restore expanded state on page load
    document.addEventListener('DOMContentLoaded', function() {
      const savedState = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      
      // Restore expanded folders
      if (savedState.expanded) {
        savedState.expanded.forEach(id => {
          const folderEl = document.querySelector(`.folder-item[data-folder-id="${id}"]`);
          if (folderEl) folderEl.classList.add('expanded');
        });
      }
      
      // Restore selected folder
      if (savedState.selected) {
        const folderEl = document.querySelector(`.folder-item[data-folder-id="${savedState.selected}"]`);
        if (folderEl) {
          folderEl.click();
        }
      }
      
      // Add upload progress tracking to material upload form
      const uploadForm = document.querySelector('#uploadModal form');
      const uploadBtn = document.getElementById('materialUploadBtn');
      const progressDiv = document.getElementById('materialUploadProgress');
      const progressBar = document.getElementById('materialUploadProgressBar');
      const progressPercentage = document.getElementById('materialUploadPercentage');
      const uploadedSizeSpan = document.getElementById('materialUploadedSize');
      const totalSizeSpan = document.getElementById('materialTotalSize');
      
      if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
          const fileInput = this.querySelector('input[type="file"]');
          const file = fileInput && fileInput.files && fileInput.files[0];
          
          // Only show progress for file uploads (not URL materials)
          if (!file) {
            return; // Let form submit normally for URL materials
          }
          
          e.preventDefault();
          
          // Show progress and disable button
          progressDiv.classList.remove('hidden');
          uploadBtn.disabled = true;
          uploadBtn.textContent = 'Uploading...';
          
          const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
          totalSizeSpan.textContent = fileSizeMB + ' MB';
          
          // Create FormData from form
          const formData = new FormData(uploadForm);
          
          // Use XMLHttpRequest for progress tracking
          const xhr = new XMLHttpRequest();
          
          xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
              const percentComplete = Math.round((e.loaded / e.total) * 100);
              progressBar.value = percentComplete;
              progressPercentage.textContent = percentComplete + '%';
              uploadedSizeSpan.textContent = (e.loaded / (1024 * 1024)).toFixed(2) + ' MB';
            }
          });
          
          xhr.addEventListener('load', () => {
            if (xhr.status === 200 || xhr.status === 302) {
              // Success - reload page
              window.location.reload();
            } else {
              progressDiv.classList.add('hidden');
              uploadBtn.disabled = false;
              uploadBtn.innerHTML = 'Upload';
              uploadBtn.classList.remove('gap-2');
              alert('Upload failed. Please try again.');
            }
          });
          
          xhr.addEventListener('error', () => {
            progressDiv.classList.add('hidden');
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = 'Upload';
            uploadBtn.classList.remove('gap-2');
            alert('Network error. Please try again.');
          });
          
          xhr.open('POST', uploadForm.action);
          xhr.send(formData);
        });
      }
    });

    // Save expanded state
    function saveExpandState() {
      const expanded = [];
      document.querySelectorAll('.folder-item.expanded').forEach(el => {
        const id = el.dataset.folderId;
        if (id) expanded.push(id);
      });
      const state = { expanded, selected: currentFolderId };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function selectFolder(el, id, name, count, sharedCount) {
      currentFolderId = id;
      currentFolderName = name;
      currentFolderSharedCount = sharedCount || 0;
      
      // Update selection
      document.querySelectorAll('.folder-item').forEach(f => f.classList.remove('selected'));
      el.classList.add('selected');
      
      // Auto-expand when selected (if has children)
      if (!el.classList.contains('expanded')) {
        el.classList.add('expanded');
      }
      
      // Save state
      saveExpandState();
      
      // Update header
      document.getElementById('folderTitle').textContent = name;
      document.getElementById('countBadge').textContent = count;
      document.getElementById('uploadTo').textContent = name;
      document.getElementById('uploadFolderId').value = id;
      
      // Update shared indicator in header
      const sharedIndicator = document.getElementById('sharedIndicator');
      if (sharedIndicator) {
        if (currentFolderSharedCount > 1) {
          sharedIndicator.classList.remove('hidden');
          sharedIndicator.textContent = 'Shared with ' + currentFolderSharedCount + ' courses';
        } else {
          sharedIndicator.classList.add('hidden');
        }
      }
      
      // Share button: show for any folder (not Course Materials root)
      const shareBtn = document.getElementById('shareFolderBtn');
      if (shareBtn) {
        shareBtn.classList.toggle('hidden', !id);
      }
      
      // Default to file tab on folder select
      // Default to file tab on folder select
      switchUploadTab('file');
      
      // Update icon (home for Course Materials, folder-open for folders)
      const folderIcon = document.getElementById('folderIcon');
      if (folderIcon) {
        if (!id) {
          folderIcon.className = 'fas fa-home text-primary';
        } else {
          folderIcon.className = 'fas fa-folder-open text-warning';
        }
      }
      
      // Show content
      document.querySelectorAll('.folder-content').forEach(c => c.classList.add('hidden'));
      var content = document.getElementById('content-' + (id || 'root'));
      if (content) content.classList.remove('hidden');
    }

    // Toggle Upload Tabs
    function switchUploadTab(mode) {
      const tabFile = document.getElementById('tabUploadFile');
      const tabUrl = document.getElementById('tabShareLink');
      const sectionFile = document.getElementById('fileUploadSection');
      const sectionUrl = document.getElementById('urlUploadSection');
      const fileInput = document.getElementById('materialFileInput');
      const urlInput = document.getElementById('materialUrlInput');
      
      if (mode === 'file') {
        // Activate File Tab
        tabFile.classList.add('tab-active');
        tabUrl.classList.remove('tab-active');
        sectionFile.classList.remove('hidden');
        sectionUrl.classList.add('hidden');
        
        // Clear URL input
        if (urlInput) urlInput.value = '';
      } else {
        // Activate URL Tab
        tabUrl.classList.add('tab-active');
        tabFile.classList.remove('tab-active');
        sectionUrl.classList.remove('hidden');
        sectionFile.classList.add('hidden');
        
        // Clear File input
        if (fileInput) fileInput.value = '';
      }
    }

    function toggleExpand(el) {
      el.classList.toggle('expanded');
      saveExpandState();
    }

    function openUploadModal() {
      // Warn if uploading to a shared folder
      if (currentFolderSharedCount > 1) {
        if (!confirm('⚠️ This folder is shared with ' + currentFolderSharedCount + ' courses.\n\nUploaded materials will appear in ALL shared courses.\n\nContinue?')) {
          return;
        }
      }
      document.getElementById('uploadTo').textContent = currentFolderName;
      document.getElementById('uploadFolderId').value = currentFolderId;
      uploadModal.showModal();
    }

    function openCreateFolderModal(parentId, sharedCount) {
      // Warn if creating subfolder in a shared folder
      if (sharedCount && sharedCount > 1) {
        if (!confirm('⚠️ This folder is shared with ' + sharedCount + ' courses.\n\nNew subfolders will appear in ALL shared courses.\n\nContinue?')) {
          return;
        }
      }
      document.getElementById('parentId').value = parentId || '';
      document.getElementById('createTitle').textContent = parentId ? 'New Subfolder' : 'New Folder';
      createModal.showModal();
    }

    let renameSharedCount = 0;
    function openRenameModal(id, name, sharedCount) {
      renameSharedCount = sharedCount || 0;
      document.getElementById('renameId').value = id;
      document.getElementById('renameName').value = name;
      renameModal.showModal();
    }

    async function submitRename() {
      const id = document.getElementById('renameId').value;
      const name = document.getElementById('renameName').value;
      
      // Warn if renaming a shared folder
      if (renameSharedCount > 1) {
        if (!confirm('⚠️ This folder is shared with ' + renameSharedCount + ' courses.\n\nRenaming will change it in ALL shared courses.\n\nContinue?')) {
          return;
        }
      }
      
      try {
        const res = await fetch('/teacher/folders/' + id, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        if ((await res.json()).success) location.reload();
        else alert('Error');
      } catch(e) { alert('Error'); }
    }

    async function deleteFolder(id, name, sharedCount) {
      let msg = 'Delete "' + name + '" and all contents?';
      if (sharedCount > 1) {
        msg = '⚠️ WARNING: This folder is shared with ' + sharedCount + ' courses!\n\n' +
              'Deleting will remove it from ALL shared courses.\n\n' +
              'Are you sure you want to delete "' + name + '"?';
      }
      if (!confirm(msg)) return;
      try {
        const res = await fetch('/teacher/folders/' + id, { method: 'DELETE' });
        if ((await res.json()).success) location.reload();
        else alert('Error');
      } catch(e) { alert('Error'); }
    }

    let materialToDelete = null;

    function deleteMaterial(btn, id, name) {
      materialToDelete = { id, name, btn };
      const msg = currentFolderSharedCount > 1 
        ? `This material is in a shared folder (${currentFolderSharedCount} courses). Deleting it will remove it from ALL shared courses.` 
        : `Are you sure you want to delete "<b>${name}</b>"?`;
      
      document.getElementById('deleteModalMessage').innerHTML = msg;
      
      // Reset confirm button state
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = 'Delete';
      confirmBtn.onclick = executeDelete;
      
      deleteModal.showModal();
    }

    async function executeDelete() {
      if (!materialToDelete) return;

      const { id, btn } = materialToDelete;
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      
      // Loading state on the MODAL button
      const originalModalBtnContent = confirmBtn.innerHTML;
      confirmBtn.disabled = true;
      confirmBtn.innerHTML = 'Deleting...';
      
      // Also show loading on the row button (optional, but good visual link)
      const originalRowBtnContent = btn.innerHTML;
      btn.innerHTML = '<span class="loading loading-dots loading-xs"></span>';
      btn.disabled = true;

      try {
        const res = await fetch('/teacher/courses/<%= course.id %>/materials/' + id, { method: 'DELETE' });
        const data = await res.json();
        
        if (data.success) {
          if (data.redirectUrl) {
            window.location.href = data.redirectUrl;
          } else {
             window.location.reload();
          }
        } else {
           throw new Error(data.message || 'Error deleting material');
        }
      } catch(e) { 
        console.error(e);
        deleteModal.close();
        
        // Reset buttons
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = originalModalBtnContent;
        
        btn.disabled = false;
        btn.innerHTML = originalRowBtnContent;
        btn.classList.remove('flex', 'items-center', 'justify-center', 'p-0');
        btn.style.minWidth = '';
        
        // Show error alert
        const alertContainer = document.getElementById('alertContainer');
        const errorAlert = document.createElement('div');
        errorAlert.className = 'alert alert-error mb-4 py-2';
        errorAlert.innerHTML = `<i class="fas fa-exclamation-circle"></i><span>${e.message || 'Error deleting material'}</span>`;
        
        // Replace existing alerts or append
         alertContainer.innerHTML = '';
         alertContainer.appendChild(errorAlert);
         
         // Scroll to top to see error
         window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    async function openShareModal() {
      if (!currentFolderId) {
        alert('Please select a folder to share (Root cannot be shared)');
        return;
      }
      document.getElementById('shareFolderName').textContent = currentFolderName;
      document.getElementById('shareFolderId').value = currentFolderId;
      
      // Fetch current shared courses for this folder
      try {
        const res = await fetch('/teacher/folders/' + currentFolderId + '/shared-courses');
        const data = await res.json();
        const sharedCourseIds = data.success ? data.courseIds : [];
        
        // Pre-check the courses this folder is already shared with
        document.querySelectorAll('.course-checkbox').forEach(cb => {
          cb.checked = sharedCourseIds.includes(parseInt(cb.value));
        });
      } catch (e) {
        // Fallback: just check the current course
        const currentCourseId = <%= course.id %>;
        document.querySelectorAll('.course-checkbox').forEach(cb => {
          cb.checked = (parseInt(cb.value) === currentCourseId);
        });
      }
      
      shareModal.showModal();
    }

    async function submitShare() {
      const folderId = document.getElementById('shareFolderId').value;
      const checkedBoxes = document.querySelectorAll('.course-checkbox:checked');
      const courseIds = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
      const currentCourseId = <%= course.id %>;
      
      // Ensure current course is always selected
      if (!courseIds.includes(currentCourseId)) {
        alert('The current course must remain selected. You cannot remove a folder from the course you are viewing it in.');
        // Re-check the current course checkbox
        document.querySelector('.course-checkbox[data-is-current="true"]').checked = true;
        return;
      }

      try {
        const response = await fetch('/teacher/folders/' + folderId + '/share', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ course_ids: courseIds })
        });

        const data = await response.json();

        if (data.success) {
          shareModal.close();
          location.reload();
        } else {
          alert(data.message || 'Error sharing folder');
        }
      } catch (error) {
        console.error('Share error:', error);
        alert('Error sharing folder');
      }
    }
  </script>
</body>
</html>
