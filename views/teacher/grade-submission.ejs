<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grade Submission | LMS EduManage</title>
  <link rel="stylesheet" href="/css/output.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="stylesheet" href="/css/teacher-theme.css">
</head>
<body>
  <%- include('../shared/navbar', { user }) %>

  <main class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs mb-4 sm:mb-6 overflow-x-auto">
      <ul>
        <li><a href="/teacher/dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
        <li><a href="/teacher/courses"><i class="fas fa-book"></i> Courses</a></li>
        <li><a href="/teacher/courses/<%= course.id %>"><i class="fas fa-graduation-cap"></i> <%= course.title %></a></li>
        <li><a href="/teacher/assignments/<%= assignment.id %>/submissions"><i class="fas fa-file-alt"></i> Submissions</a></li>
        <li><i class="fas fa-pen"></i> Grade Submission</li>
      </ul>
    </div>

    <!-- Page Header -->
    <div class="mb-6 sm:mb-8">
      <h1 class="text-2xl sm:text-3xl font-bold mb-2">
        <i class="fas fa-pen mr-2"></i>Grade Submission
      </h1>
      <div class="card bg-base-100 shadow-xl border border-base-200">
        <div class="card-body p-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <p class="text-sm text-base-content/70">Student</p>
              <p class="font-semibold"><%= submission.student.full_name %></p>
              <p class="text-sm text-base-content/60"><%= submission.student.email %></p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Assignment</p>
              <p class="font-semibold"><%= assignment.title %></p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Submitted</p>
              <p class="font-semibold">
                <%= new Date(submission.submitted_at || submission.submittedAt).toLocaleString('en-US', { 
                  year: 'numeric', month: 'short', day: 'numeric', 
                  hour: '2-digit', minute: '2-digit' 
                }) %>
              </p>
              <% 
                const submittedDate = new Date(submission.submitted_at || submission.submittedAt);
                const deadlineDate = new Date(assignment.deadline);
                const isLate = submittedDate > deadlineDate;
              %>
              <% if (isLate) { %>
                <span class="badge badge-error badge-sm">Late Submission</span>
              <% } else { %>
                <span class="badge badge-success badge-sm">On Time</span>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Messages -->
    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-error mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span><%= error %></span>
      </div>
    <% } %>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Student Work (2/3 width on large screens) -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Assignment Description -->
        <div class="card bg-base-100 shadow-lg">
          <div class="card-body">
            <h2 class="card-title">
              <i class="fas fa-align-left text-primary mr-2"></i>
              Assignment Description
            </h2>
            <div class="divider my-2"></div>
            <% if (assignment.description) { %>
              <p class="whitespace-pre-wrap"><%= assignment.description %></p>
            <% } else { %>
              <p class="text-base-content/50 italic">No description provided</p>
            <% } %>
          </div>
        </div>

        <!-- Submission Content -->
        <div class="card bg-base-100 shadow-lg">
          <div class="card-body">
            <h2 class="card-title">
              <i class="fas fa-file-contract text-primary mr-2"></i>
              Student Submission
            </h2>
            <div class="divider my-2"></div>

            <!-- File Download -->
            <% if (submission.file_url) { %>
              <div class="bg-base-200 p-4 rounded-lg mb-4">
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-3">
                    <i class="fas fa-file-alt text-primary text-3xl"></i>
                    <div>
                      <p class="font-semibold">Submitted File</p>
                      <p class="text-sm text-base-content/60">Click to view or download</p>
                    </div>
                  </div>
                  <a href="<%= submission.file_url %>" target="_blank" class="btn btn-primary">
                    <i class="fas fa-download mr-2"></i>
                    Open File
                  </a>
                </div>
              </div>
            <% } %>

            <!-- Text Submission -->
            <% if (submission.submission_text) { %>
              <div>
                <p class="font-semibold mb-2">Text Submission:</p>
                <div class="bg-base-200 p-4 rounded-lg">
                  <p class="whitespace-pre-wrap"><%= submission.submission_text %></p>
                </div>
              </div>
            <% } %>

            <% if (!submission.file_url && !submission.submission_text) { %>
              <div class="alert alert-warning shadow-sm rounded-xl">
                <i class="fas fa-exclamation-triangle"></i>
                <span>No file or text content submitted</span>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Previous Feedback (if exists) -->
        <% if (submission.marks !== null || submission.feedback) { %>
          <div class="card bg-warning/10 border border-warning shadow-lg">
            <div class="card-body">
              <h2 class="card-title text-warning">
                <i class="fas fa-star mr-2"></i>
                Current Grade
              </h2>
              <div class="divider my-2"></div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <p class="text-sm text-base-content/70">Score</p>
                  <p class="text-2xl font-bold">
                    <%= submission.marks !== null ? submission.marks + '%' : 'Not graded' %>
                  </p>
                </div>
                <div>
                  <p class="text-sm text-base-content/70">Graded By</p>
                  <p class="font-semibold">
                    <%= submission.graded_by ? 'Teacher' : 'N/A' %>
                  </p>
                </div>
              </div>
              <% if (submission.feedback) { %>
                <div class="mt-4">
                  <p class="text-sm text-base-content/70 mb-2">Previous Feedback:</p>
                  <div class="bg-base-100 p-3 rounded-lg">
                    <p class="whitespace-pre-wrap"><%= submission.feedback %></p>
                  </div>
                </div>
              <% } %>
            </div>
          </div>
        <% } %>
      </div>

      <!-- Grading Form (1/3 width on large screens) -->
      <div class="lg:col-span-1">
        <div class="card bg-base-100 shadow-lg sticky top-4">
          <div class="card-body">
            <h2 class="card-title">
              <i class="fas fa-check-circle text-success mr-2"></i>
              <% if (submission.marks !== null) { %>
                Update Grade
              <% } else { %>
                Assign Grade
              <% } %>
            </h2>
            <div class="divider my-2"></div>

            <form method="POST" action="/teacher/submissions/<%= submission.id %>/grade" id="gradeForm">
              <!-- Score Input -->
              <div class="form-control mb-4">
                <label class="label">
                  <span class="label-text font-semibold">
                    Score (0-100) <span class="text-error">*</span>
                  </span>
                </label>
                <input 
                  type="number" 
                  name="marks" 
                  class="input input-bordered w-full" 
                  min="0" 
                  max="100" 
                  step="0.01"
                  value="<%= submission.marks !== null ? submission.marks : '' %>"
                  required
                  placeholder="Enter score (e.g., 85.5)"
                >
                <label class="label">
                  <span class="label-text-alt text-base-content/60">Enter a percentage score (0-100)</span>
                </label>
              </div>

              <!-- Feedback Textarea -->
              <div class="form-control mb-6">
                <label class="label">
                  <span class="label-text font-semibold">Feedback (Optional)</span>
                </label>
                <textarea 
                  name="feedback" 
                  class="textarea textarea-bordered h-32" 
                  placeholder="Provide feedback to the student..."
                ><%= submission.feedback || '' %></textarea>
                <label class="label">
                  <span class="label-text-alt text-base-content/60">Give constructive feedback</span>
                </label>
              </div>

              <!-- Action Buttons -->
              <div class="flex gap-3">
                <button type="submit" class="btn btn-primary rounded-full flex-1 shadow-md hover:shadow-lg transition-all" onclick="this.disabled=true; this.innerHTML='<span class=\'loading loading-spinner\'></span> Saving...'; this.form.submit();">
                  <i class="fas fa-save mr-2"></i>
                  Save Grade
                </button>
                <a href="/teacher/assignments/<%= assignment.id %>/submissions" class="btn btn-error text-white rounded-full shadow-md hover:shadow-lg transition-all">
                  Cancel
                </a>
              </div>
            </form>

            <!-- Guidelines -->
            <div class="divider my-4"></div>
            <div class="alert alert-info text-sm rounded-xl shadow-sm">
              <i class="fas fa-info-circle"></i>
              <div>
                <p class="font-semibold">Grading Tips:</p>
                <ul class="list-disc list-inside mt-2 space-y-1">
                  <li>Score must be 0-100</li>
                  <li>Feedback is optional but recommended</li>
                  <li>You can update grades later</li>
                  <li>Late submissions are marked</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Back Button -->
    <div class="mt-6">
      <a href="/teacher/assignments/<%= assignment.id %>/submissions" class="btn btn-ghost rounded-full gap-2">
        <i class="fas fa-arrow-left"></i>
        Back to Submissions
      </a>
    </div>
  </main>

  <%- include('../shared/footer') %>

  <!-- Client-side Validation -->
  <script>
    document.getElementById('gradeForm').addEventListener('submit', function(e) {
      const marks = parseFloat(document.querySelector('input[name="marks"]').value);
      
      if (isNaN(marks) || marks < 0 || marks > 100) {
        e.preventDefault();
        alert('Score must be between 0 and 100');
        return false;
      }
    });
  </script>
</body>
</html>
