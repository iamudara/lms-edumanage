<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assignment Submissions | LMS EduManage</title>
  <link rel="stylesheet" href="/css/output.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="stylesheet" href="/css/teacher-theme.css">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* DataTables custom styling */
    .dataTables_wrapper .dataTables_length select,
    .dataTables_length select,
    select[name="submissionsTable_length"] {
      padding: 0.5rem 2rem 0.5rem 0.75rem !important;
      border: 1px solid rgba(0, 0, 0, 0.1) !important;
      border-radius: 0.5rem !important;
      background-color: white !important;
      font-size: 0.875rem !important;
      min-height: 2.5rem !important;
      appearance: auto !important;
    }
    
    [data-theme="dark"] .dataTables_wrapper .dataTables_length select,
    [data-theme="dark"] .dataTables_length select,
    [data-theme="dark"] select[name="submissionsTable_length"] {
      background-color: #374151 !important;
      border-color: rgba(75, 107, 251, 0.2) !important;
      color: #f3f4f6 !important;
    }
    
    .dataTables_wrapper .dataTables_filter input {
      padding: 0.5rem 0.75rem;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 0.5rem;
      background-color: white;
      font-size: 0.875rem;
      min-height: 2.5rem;
      margin-left: 0.5rem;
    }
    
    [data-theme="dark"] .dataTables_wrapper .dataTables_filter input {
      background-color: #374151;
      border-color: rgba(75, 107, 251, 0.2);
      color: #f3f4f6;
    }
    
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter {
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .dataTables_wrapper .dataTables_length label,
    .dataTables_wrapper .dataTables_filter label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button {
      padding: 0.5rem 0.75rem;
      margin: 0 0.125rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(0, 0, 0, 0.1);
      background-color: white;
      color: inherit;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
      background: linear-gradient(135deg, #4b6bfb 0%, #3b5bdb 100%);
      color: white;
      border-color: transparent;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
      background: rgba(75, 107, 251, 0.1);
      border-color: rgba(75, 107, 251, 0.3);
      color: inherit;
    }
    
    [data-theme="dark"] .dataTables_wrapper .dataTables_paginate .paginate_button {
      background-color: #1f2937;
      border-color: rgba(75, 107, 251, 0.2);
    }
    
    [data-theme="dark"] .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
      background-color: rgba(75, 107, 251, 0.15);
    }
    
    /* DataTables responsive - full width on mobile when expanded */
    @media screen and (max-width: 1023px) {
      table.dataTable.dtr-inline.collapsed > tbody > tr > td.dtr-control,
      table.dataTable.dtr-inline.collapsed > tbody > tr > th.dtr-control {
        position: relative;
      }
      
      table.dataTable.dtr-inline.collapsed > tbody > tr.parent > td.child,
      table.dataTable > tbody > tr.child {
        padding: 1rem !important;
      }
      
      table.dataTable > tbody > tr.child ul.dtr-details {
        width: 100% !important;
      }
      
      table.dataTable > tbody > tr.child ul.dtr-details > li {
        border-bottom: none !important;
        padding: 0.75rem 0;
      }
    }
  </style>
  <!-- jQuery (required for DataTables) -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
</head>
<body>
  <%- include('../shared/navbar', { user }) %>

  <main class="container mx-auto px-4 py-4 sm:py-8">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs mb-4 sm:mb-6">
      <ul>
        <li class="hidden sm:inline"><a href="/teacher/dashboard"><i class="fas fa-home mr-1"></i>Dashboard</a></li>
        <li><a href="/teacher/courses"><i class="fas fa-book mr-1"></i>Courses</a></li>
        <li><a href="/teacher/courses/<%= course.id %>"><%= course.title %></a></li>
        <li>Submissions: <%= assignment.title %></li>
      </ul>
    </div>

    <!-- Page Header -->
    <div class="mb-6 sm:mb-8">
      <h1 class="text-2xl sm:text-3xl font-bold mb-2">
        <i class="fas fa-file-alt mr-2"></i>Assignment Submissions
      </h1>
      <div class="card bg-base-200 shadow-sm">
        <div class="card-body p-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <p class="text-sm text-base-content/70">Assignment</p>
              <p class="font-semibold"><%= assignment.title %></p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Course</p>
              <p class="font-semibold"><%= course.code %> - <%= course.title %></p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Deadline</p>
              <p class="font-semibold">
                <%= new Date(assignment.deadline).toLocaleString('en-US', { 
                  year: 'numeric', month: 'short', day: 'numeric', 
                  hour: '2-digit', minute: '2-digit' 
                }) %>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Success/Error Messages -->
    <% if (typeof success !== 'undefined' && success) { %>
      <div class="alert alert-success mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span><%= success %></span>
      </div>
    <% } %>

    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-error mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span><%= error %></span>
      </div>
    <% } %>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
      <div class="stats shadow bg-primary">
        <div class="stat">
          <div class="stat-figure">
            <i class="fas fa-file-alt text-3xl"></i>
          </div>
          <div class="stat-title">Total Submissions</div>
          <div class="stat-value text-2xl sm:text-3xl"><%= submissions.length %></div>
        </div>
      </div>
      <div class="stats shadow" style="background: linear-gradient(135deg, #36d399 0%, #2ab880 100%); color: white;">
        <div class="stat">
          <div class="stat-figure">
            <i class="fas fa-check-circle text-3xl"></i>
          </div>
          <div class="stat-title" style="color: rgba(255,255,255,0.9);">Graded</div>
          <div class="stat-value text-2xl sm:text-3xl">
            <%= submissions.filter(s => s.marks !== null).length %>
          </div>
        </div>
      </div>
      <div class="stats shadow" style="background: linear-gradient(135deg, #fbbd23 0%, #e0a720 100%); color: #1f2937;">
        <div class="stat">
          <div class="stat-figure">
            <i class="fas fa-hourglass-half text-3xl"></i>
          </div>
          <div class="stat-title" style="color: rgba(31,41,55,0.8);">Pending</div>
          <div class="stat-value text-2xl sm:text-3xl">
            <%= submissions.filter(s => s.marks === null).length %>
          </div>
        </div>
      </div>
      <div class="stats shadow" style="background: linear-gradient(135deg, #3abff8 0%, #22a0d8 100%); color: white;">
        <div class="stat">
          <div class="stat-figure">
            <i class="fas fa-chart-line text-3xl"></i>
          </div>
          <div class="stat-title" style="color: rgba(255,255,255,0.9);">Average Score</div>
          <div class="stat-value text-2xl sm:text-3xl">
            <% 
              const gradedSubmissions = submissions.filter(s => s.marks !== null);
              const avgScore = gradedSubmissions.length > 0 
                ? (gradedSubmissions.reduce((sum, s) => sum + s.marks, 0) / gradedSubmissions.length).toFixed(1)
                : 'N/A';
            %>
            <%= avgScore %><% if (avgScore !== 'N/A') { %>%<% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Submissions Table -->
    <div class="card bg-base-100 shadow-xl mt-8 sm:mt-12">
      <div class="card-body p-2 sm:p-6">
        <h2 class="card-title mb-4 px-2 sm:px-0">
          <i class="fas fa-clipboard-list mr-2"></i>
          All Submissions
        </h2>

        <% if (submissions.length === 0) { %>
          <div class="alert alert-info">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span>No submissions yet for this assignment.</span>
          </div>
        <% } else { %>
          <!-- Desktop Table View -->
          <div class="overflow-x-auto lg:overflow-x-visible -mx-2 sm:mx-0 hidden lg:block">
            <table id="submissionsTable" class="table table-zebra w-full">
              <thead>
                <tr>
                  <th>Student Name</th>
                  <th>Email</th>
                  <th>Submitted Date</th>
                  <th>Status</th>
                  <th>Score</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% submissions.forEach(submission => { %>
                  <tr>
                    <td>
                      <div class="flex items-center gap-3">
                        <div class="avatar placeholder flex-shrink-0">
                          <div class="rounded-full w-10 h-10 flex items-center justify-center" style="background: linear-gradient(135deg, #4b6bfb 0%, #3b5bdb 100%); color: white;">
                            <span class="text-sm font-semibold"><%= submission.student.full_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() %></span>
                          </div>
                        </div>
                        <div>
                          <div class="font-bold"><%= submission.student.full_name %></div>
                          <% if (submission.student.batch) { %>
                            <div class="text-sm opacity-70">
                              <span class="badge badge-sm badge-ghost"><%= submission.student.batch.code %></span>
                            </div>
                          <% } %>
                        </div>
                      </div>
                    </td>
                    <td><%= submission.student.email %></td>
                    <td>
                      <%= new Date(submission.submitted_at || submission.submittedAt).toLocaleString('en-US', { 
                        year: 'numeric', month: 'short', day: 'numeric', 
                        hour: '2-digit', minute: '2-digit' 
                      }) %>
                      <% 
                        const submittedDate = new Date(submission.submitted_at || submission.submittedAt);
                        const deadlineDate = new Date(assignment.deadline);
                        const isLate = submittedDate > deadlineDate;
                      %>
                      <% if (isLate) { %>
                        <span class="badge badge-error badge-sm ml-2">Late</span>
                      <% } %>
                    </td>
                    <td>
                      <% if (submission.marks !== null && submission.marks !== undefined) { %>
                        <span class="badge badge-success">Graded</span>
                      <% } else { %>
                        <span class="badge badge-warning">Pending</span>
                      <% } %>
                    </td>
                    <td>
                      <% if (submission.marks !== null && submission.marks !== undefined) { %>
                        <span class="font-bold text-success"><%= submission.marks %>%</span>
                      <% } else { %>
                        <span class="text-base-content/50">â€”</span>
                      <% } %>
                    </td>
                    <td>
                      <div class="flex flex-row gap-1">
                        <% if (submission.file_url) { %>
                          <a href="<%= submission.file_url %>" target="_blank" class="btn btn-xs sm:btn-sm btn-ghost" title="View File">
                            <i class="fas fa-eye text-xs"></i>
                          </a>
                        <% } %>
                        <a href="/teacher/submissions/<%= submission.id %>/grade" class="btn btn-xs sm:btn-sm btn-primary">
                          <% if (submission.marks !== null && submission.marks !== undefined) { %>
                            <i class="fas fa-edit text-xs sm:mr-1"></i><span class="hidden sm:inline">Edit Grade</span>
                          <% } else { %>
                            <i class="fas fa-pen text-xs sm:mr-1"></i><span class="hidden sm:inline">Grade</span>
                          <% } %>
                        </a>
                      </div>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>

          <!-- Mobile Collapsible Cards -->
          <div class="lg:hidden space-y-3">
            <% submissions.forEach(submission => { %>
              <% 
                const submittedDate = new Date(submission.submitted_at || submission.submittedAt);
                const deadlineDate = new Date(assignment.deadline);
                const isLate = submittedDate > deadlineDate;
              %>
              <div class="collapse collapse-arrow bg-base-200 rounded-lg">
                <input type="checkbox" class="peer" />
                <div class="collapse-title">
                  <div class="flex items-center gap-3">
                    <div class="avatar placeholder flex-shrink-0">
                      <div class="rounded-full w-10 h-10 flex items-center justify-center" style="background: linear-gradient(135deg, #4b6bfb 0%, #3b5bdb 100%); color: white;">
                        <span class="text-xs font-semibold"><%= submission.student.full_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() %></span>
                      </div>
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="font-bold truncate"><%= submission.student.full_name %></div>
                      <div class="text-xs text-base-content/70 truncate"><%= submission.student.email %></div>
                      <div class="flex items-center gap-2 mt-1">
                        <% if (submission.marks !== null && submission.marks !== undefined) { %>
                          <span class="badge badge-success badge-xs">Graded</span>
                          <span class="text-xs font-semibold text-success"><%= submission.marks %>%</span>
                        <% } else { %>
                          <span class="badge badge-warning badge-xs">Pending</span>
                        <% } %>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="collapse-content">
                  <div class="space-y-3 pt-2">
                    <!-- Submitted Date -->
                    <div class="flex justify-between items-start">
                      <span class="text-sm font-semibold">Submitted:</span>
                      <div class="text-right">
                        <div class="text-sm">
                          <%= new Date(submission.submitted_at || submission.submittedAt).toLocaleString('en-US', { 
                            year: 'numeric', month: 'short', day: 'numeric', 
                            hour: '2-digit', minute: '2-digit' 
                          }) %>
                        </div>
                        <% if (isLate) { %>
                          <span class="badge badge-error badge-xs mt-1">Late</span>
                        <% } %>
                      </div>
                    </div>

                    <!-- Batch -->
                    <% if (submission.student.batch) { %>
                      <div class="flex justify-between items-center">
                        <span class="text-sm font-semibold">Batch:</span>
                        <span class="badge badge-ghost"><%= submission.student.batch.code %></span>
                      </div>
                    <% } %>

                    <!-- Score -->
                    <div class="flex justify-between items-center">
                      <span class="text-sm font-semibold">Score:</span>
                      <% if (submission.marks !== null && submission.marks !== undefined) { %>
                        <span class="font-bold text-lg text-success"><%= submission.marks %>%</span>
                      <% } else { %>
                        <span class="text-base-content/50">Not graded yet</span>
                      <% } %>
                    </div>

                    <!-- Actions -->
                    <div class="divider my-2"></div>
                    <div class="flex flex-col gap-2">
                      <% if (submission.file_url) { %>
                        <a href="<%= submission.file_url %>" target="_blank" class="btn btn-ghost btn-sm btn-block justify-start">
                          <i class="fas fa-eye text-sm"></i>
                          View Submission File
                        </a>
                      <% } %>
                      <a href="/teacher/submissions/<%= submission.id %>/grade" class="btn btn-primary btn-sm btn-block">
                        <% if (submission.marks !== null && submission.marks !== undefined) { %>
                          <i class="fas fa-edit text-sm"></i>
                          Edit Grade
                        <% } else { %>
                          <i class="fas fa-pen text-sm"></i>
                          Grade Submission
                        <% } %>
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Bulk Grade Upload Section -->
    <% if (canGrade && submissions.length > 0) { %>
      <div class="card bg-base-100 shadow-xl mt-6 sm:mt-8">
        <div class="card-body p-4 sm:p-6">
          <h2 class="card-title mb-4 sm:mb-6 text-lg sm:text-xl">
            <i class="fas fa-upload mr-2"></i>
            Bulk Grade Upload
          </h2>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
            <!-- Upload Form -->
            <div>
              <p class="text-sm text-base-content/70 mb-4">
                Upload a CSV file to grade multiple submissions at once. The file should contain student email/username and their score.
              </p>
              
              <form action="/teacher/assignments/<%= assignment.id %>/grades/bulk" method="POST" enctype="multipart/form-data">
                <div class="form-control w-full">
                  <label class="label">
                    <span class="label-text font-semibold">CSV File</span>
                  </label>
                  <input type="file" name="csvFile" accept=".csv" class="file-input file-input-bordered file-input-primary w-full" required>
                  <label class="label">
                    <span class="label-text-alt">Accepted format: .csv</span>
                  </label>
                </div>
                
                <button type="submit" class="btn btn-primary w-full sm:w-auto mt-4" style="padding: 10px; display: inline-flex; align-items: center; gap: 0.5rem;">
                  <i class="fas fa-upload"></i>
                  <span>Upload & Grade</span>
                </button>
              </form>
            </div>
            
            <!-- Instructions & Template -->
            <div>
              <div class="bg-base-200 p-4 rounded-lg">
                <h3 class="font-semibold mb-3 flex items-center">
                  <i class="fas fa-info-circle mr-2 text-info"></i>
                  CSV Format Requirements
                </h3>
                <ul class="text-sm space-y-2 text-base-content/80">
                  <li class="flex items-start gap-2">
                    <i class="fas fa-check text-success mt-1 text-xs"></i>
                    <span>Required columns: <code class="px-2 py-1 bg-base-300 rounded text-xs">student_email</code> or <code class="px-2 py-1 bg-base-300 rounded text-xs">username</code>, <code class="px-2 py-1 bg-base-300 rounded text-xs">marks</code></span>
                  </li>
                  <li class="flex items-start gap-2">
                    <i class="fas fa-check text-success mt-1 text-xs"></i>
                    <span>Optional column: <code class="px-2 py-1 bg-base-300 rounded text-xs">feedback</code></span>
                  </li>
                  <li class="flex items-start gap-2">
                    <i class="fas fa-check text-success mt-1 text-xs"></i>
                    <span>Marks should be between 0-100</span>
                  </li>
                  <li class="flex items-start gap-2">
                    <i class="fas fa-check text-success mt-1 text-xs"></i>
                    <span>Only students who have submitted can be graded</span>
                  </li>
                </ul>
                
                <div class="divider my-3 text-xs">Template</div>
                
                <a href="/teacher/assignments/<%= assignment.id %>/grades/template" class="btn btn-outline btn-sm w-full sm:w-auto">
                  <i class="fas fa-download mr-2"></i>
                  Download Template CSV
                </a>
                <p class="text-xs text-base-content/60 mt-2">
                  Pre-filled with students who have submitted this assignment
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% } %>

    <!-- Back Button -->
    <div class="mt-6">
      <a href="/teacher/courses/<%= course.id %>" class="btn btn-outline">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
        Back to Course
      </a>
    </div>
  </main>

  <%- include('../shared/footer') %>

  <!-- DataTables Initialization -->
  <script>
    $(document).ready(function() {
      $('#submissionsTable').DataTable({
        responsive: true,
        pageLength: 25,
        order: [[2, 'desc']], // Sort by submission date (newest first)
        language: {
          search: "Search students:",
          lengthMenu: "Show _MENU_ submissions per page",
          info: "Showing _START_ to _END_ of _TOTAL_ submissions",
          infoEmpty: "No submissions available",
          infoFiltered: "(filtered from _MAX_ total submissions)"
        },
        columnDefs: [
          { orderable: false, targets: [5] } // Disable sorting on Actions column
        ]
      });
    });
  </script>
</body>
</html>
