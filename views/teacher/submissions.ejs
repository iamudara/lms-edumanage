<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assignment Submissions | LMS EduManage</title>
  <link rel="stylesheet" href="/css/output.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="stylesheet" href="/css/teacher-theme.css">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
  <!-- jQuery (required for DataTables) -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
</head>
<body>
  <%- include('../shared/navbar', { user }) %>

  <main class="container mx-auto px-4 py-4 sm:py-8">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs mb-4 sm:mb-6">
      <ul>
        <li><a href="/teacher/dashboard"><i class="fas fa-home mr-1"></i>Dashboard</a></li>
        <li><a href="/teacher/courses"><i class="fas fa-book mr-1"></i>Courses</a></li>
        <li><a href="/teacher/courses/<%= course.id %>"><%= course.title %></a></li>
        <li>Submissions: <%= assignment.title %></li>
      </ul>
    </div>

    <!-- Page Header -->
    <div class="mb-6 sm:mb-8">
      <h1 class="text-2xl sm:text-3xl font-bold mb-2">
        <i class="fas fa-file-alt mr-2"></i>Assignment Submissions
      </h1>
      <div class="card bg-base-200 shadow-sm">
        <div class="card-body p-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <p class="text-sm text-base-content/70">Assignment</p>
              <p class="font-semibold"><%= assignment.title %></p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Course</p>
              <p class="font-semibold"><%= course.code %> - <%= course.title %></p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Deadline</p>
              <p class="font-semibold">
                <%= new Date(assignment.deadline).toLocaleString('en-US', { 
                  year: 'numeric', month: 'short', day: 'numeric', 
                  hour: '2-digit', minute: '2-digit' 
                }) %>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Success/Error Messages -->
    <% if (typeof success !== 'undefined' && success) { %>
      <div class="alert alert-success mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span><%= success %></span>
      </div>
    <% } %>

    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-error mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span><%= error %></span>
      </div>
    <% } %>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <div class="card bg-base-100 shadow-md">
        <div class="card-body p-4">
          <div class="stat">
            <div class="stat-title text-sm">Total Submissions</div>
            <div class="stat-value text-2xl text-primary"><%= submissions.length %></div>
          </div>
        </div>
      </div>
      <div class="card bg-base-100 shadow-md">
        <div class="card-body p-4">
          <div class="stat">
            <div class="stat-title text-sm">Graded</div>
            <div class="stat-value text-2xl text-success">
              <%= submissions.filter(s => s.marks !== null).length %>
            </div>
          </div>
        </div>
      </div>
      <div class="card bg-base-100 shadow-md">
        <div class="card-body p-4">
          <div class="stat">
            <div class="stat-title text-sm">Pending</div>
            <div class="stat-value text-2xl text-warning">
              <%= submissions.filter(s => s.marks === null).length %>
            </div>
          </div>
        </div>
      </div>
      <div class="card bg-base-100 shadow-md">
        <div class="card-body p-4">
          <div class="stat">
            <div class="stat-title text-sm">Average Score</div>
            <div class="stat-value text-2xl text-info">
              <% 
                const gradedSubmissions = submissions.filter(s => s.marks !== null);
                const avgScore = gradedSubmissions.length > 0 
                  ? (gradedSubmissions.reduce((sum, s) => sum + s.marks, 0) / gradedSubmissions.length).toFixed(1)
                  : 'N/A';
              %>
              <%= avgScore %><% if (avgScore !== 'N/A') { %>%<% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Submissions Table -->
    <div class="card bg-base-100 shadow-lg">
      <div class="card-body">
        <h2 class="card-title mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
          </svg>
          All Submissions
        </h2>

        <% if (submissions.length === 0) { %>
          <div class="alert alert-info">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span>No submissions yet for this assignment.</span>
          </div>
        <% } else { %>
          <div class="overflow-x-auto">
            <table id="submissionsTable" class="table table-zebra w-full">
              <thead>
                <tr>
                  <th>Student Name</th>
                  <th>Email</th>
                  <th>Submitted Date</th>
                  <th>Status</th>
                  <th>Score</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% submissions.forEach(submission => { %>
                  <tr>
                    <td>
                      <div class="flex items-center space-x-3">
                        <div class="avatar placeholder">
                          <div class="bg-neutral-focus text-neutral-content rounded-full w-10">
                            <span class="text-sm"><%= submission.student.full_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() %></span>
                          </div>
                        </div>
                        <div>
                          <div class="font-bold"><%= submission.student.full_name %></div>
                          <% if (submission.student.batch) { %>
                            <div class="text-sm opacity-70">
                              <span class="badge badge-sm badge-ghost"><%= submission.student.batch.code %></span>
                            </div>
                          <% } %>
                        </div>
                      </div>
                    </td>
                    <td><%= submission.student.email %></td>
                    <td>
                      <%= new Date(submission.submitted_at || submission.submittedAt).toLocaleString('en-US', { 
                        year: 'numeric', month: 'short', day: 'numeric', 
                        hour: '2-digit', minute: '2-digit' 
                      }) %>
                      <% 
                        const submittedDate = new Date(submission.submitted_at || submission.submittedAt);
                        const deadlineDate = new Date(assignment.deadline);
                        const isLate = submittedDate > deadlineDate;
                      %>
                      <% if (isLate) { %>
                        <span class="badge badge-error badge-sm ml-2">Late</span>
                      <% } %>
                    </td>
                    <td>
                      <% if (submission.marks !== null && submission.marks !== undefined) { %>
                        <span class="badge badge-success">Graded</span>
                      <% } else { %>
                        <span class="badge badge-warning">Pending</span>
                      <% } %>
                    </td>
                    <td>
                      <% if (submission.marks !== null && submission.marks !== undefined) { %>
                        <span class="font-bold text-success"><%= submission.marks %>%</span>
                      <% } else { %>
                        <span class="text-base-content/50">â€”</span>
                      <% } %>
                    </td>
                    <td>
                      <div class="flex gap-2">
                        <% if (submission.file_url) { %>
                          <a href="<%= submission.file_url %>" target="_blank" class="btn btn-sm btn-ghost" title="View File">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                          </a>
                        <% } %>
                        <a href="/teacher/submissions/<%= submission.id %>/grade" class="btn btn-sm btn-primary">
                          <% if (submission.marks !== null && submission.marks !== undefined) { %>
                            Edit Grade
                          <% } else { %>
                            Grade
                          <% } %>
                        </a>
                      </div>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Bulk Grade Upload Section -->
    <% if (canGrade && submissions.length > 0) { %>
      <div class="card bg-base-100 shadow-lg mt-8">
        <div class="card-body">
          <h2 class="card-title mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
            </svg>
            Bulk Grade Upload
          </h2>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Upload Form -->
            <div>
              <p class="text-sm text-base-content/70 mb-4">
                Upload a CSV file to grade multiple submissions at once. The file should contain student email/username and their score.
              </p>
              
              <form action="/teacher/assignments/<%= assignment.id %>/grades/bulk" method="POST" enctype="multipart/form-data">
                <div class="form-control w-full">
                  <label class="label">
                    <span class="label-text">CSV File</span>
                  </label>
                  <input type="file" name="csvFile" accept=".csv" class="file-input file-input-bordered file-input-primary w-full" required>
                  <label class="label">
                    <span class="label-text-alt">Accepted format: .csv</span>
                  </label>
                </div>
                
                <button type="submit" class="btn btn-primary mt-4">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                  </svg>
                  Upload & Grade
                </button>
              </form>
            </div>
            
            <!-- Instructions & Template -->
            <div>
              <div class="bg-base-200 p-4 rounded-lg">
                <h3 class="font-semibold mb-2">CSV Format Requirements</h3>
                <ul class="text-sm space-y-1 list-disc list-inside text-base-content/80">
                  <li>Required columns: <code class="badge badge-sm">student_email</code> or <code class="badge badge-sm">username</code>, <code class="badge badge-sm">marks</code></li>
                  <li>Optional column: <code class="badge badge-sm">feedback</code></li>
                  <li>Marks should be between 0-100</li>
                  <li>Only students who have submitted can be graded</li>
                </ul>
                
                <div class="divider my-3">Template</div>
                
                <a href="/teacher/assignments/<%= assignment.id %>/grades/template" class="btn btn-outline btn-sm">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                  </svg>
                  Download Template CSV
                </a>
                <p class="text-xs text-base-content/60 mt-2">
                  Pre-filled with students who have submitted this assignment
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% } %>

    <!-- Back Button -->
    <div class="mt-6">
      <a href="/teacher/courses/<%= course.id %>" class="btn btn-outline">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
        Back to Course
      </a>
    </div>
  </main>

  <%- include('../shared/footer') %>

  <!-- DataTables Initialization -->
  <script>
    $(document).ready(function() {
      $('#submissionsTable').DataTable({
        responsive: true,
        pageLength: 25,
        order: [[2, 'desc']], // Sort by submission date (newest first)
        language: {
          search: "Search students:",
          lengthMenu: "Show _MENU_ submissions per page",
          info: "Showing _START_ to _END_ of _TOTAL_ submissions",
          infoEmpty: "No submissions available",
          infoFiltered: "(filtered from _MAX_ total submissions)"
        },
        columnDefs: [
          { orderable: false, targets: [5] } // Disable sorting on Actions column
        ]
      });
    });
  </script>
</body>
</html>
