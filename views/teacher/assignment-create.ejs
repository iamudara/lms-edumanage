<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= pageTitle %> - LMS EduManage</title>
  <link rel="stylesheet" href="/css/output.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="stylesheet" href="/css/teacher-theme.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Flatpickr for beautiful datetime picker -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
</head>
<body>
  <%- include('../shared/navbar') %>

  <div class="container mx-auto px-3 sm:px-4 py-4 sm:py-8 max-w-7xl">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs mb-4 sm:mb-6 overflow-x-auto">
      <ul>
        <li><a href="/teacher/dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
        <li><a href="/teacher/courses"><i class="fas fa-book"></i> Courses</a></li>
        <li><a href="/teacher/courses/<%= course.id %>"><i class="fas fa-graduation-cap"></i> <%= course.code %></a></li>
        <li class="font-semibold"><i class="fas fa-plus-circle"></i> Create Assignment</li>
      </ul>
    </div>

    <!-- Page Header -->
    <div class="mb-6 sm:mb-8">
      <h1 class="text-2xl sm:text-3xl font-bold mb-2">
        <i class="fas fa-tasks mr-2"></i>Create Assignment
      </h1>
      <p class="text-sm sm:text-base text-base-content/70">
        <%= course.code %> - <%= course.title %>
      </p>
    </div>

    <!-- Success/Error Messages -->
    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-error mb-6">
        <i class="fas fa-exclamation-circle"></i>
        <span><%= error %></span>
      </div>
    <% } %>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Assignment Form (2/3 width) -->
      <div class="lg:col-span-2">
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <h2 class="card-title text-2xl mb-6">
              <i class="fas fa-edit mr-2"></i>Assignment Details
            </h2>

            <form action="/teacher/courses/<%= course.id %>/assignments" method="POST" id="assignmentForm" enctype="multipart/form-data">
              <!-- Title -->
              <div class="form-control mb-4">
                <label class="label">
                  <span class="label-text font-semibold">
                    Title <span class="text-error">*</span>
                  </span>
                </label>
                <input 
                  type="text" 
                  name="title" 
                  placeholder="e.g., Week 1 Programming Assignment" 
                  class="input input-bordered w-full"
                  required
                  maxlength="200"
                >
                <label class="label">
                  <span class="label-text-alt text-base-content/60">Maximum 200 characters</span>
                </label>
              </div>

              <!-- Description -->
              <div class="form-control mb-4">
                <label class="label">
                  <span class="label-text font-semibold">Description</span>
                </label>
                <textarea 
                  name="description" 
                  rows="6"
                  placeholder="Provide detailed instructions for the assignment..."
                  class="textarea textarea-bordered w-full"
                ></textarea>
                <label class="label">
                  <span class="label-text-alt text-base-content/60 break-words">Optional - Provide instructions, requirements, or guidelines</span>
                </label>
              </div>

              <!-- Deadline -->
              <div class="form-control mb-6">
                <label class="label">
                  <span class="label-text font-semibold">
                    Deadline <span class="text-error">*</span>
                  </span>
                </label>
                <input 
                  type="text" 
                  name="deadline" 
                  class="input input-bordered w-full"
                  required
                  id="deadlineInput"
                  placeholder="Select date and time"
                  readonly
                >
                <label class="label">
                  <span class="label-text-alt text-base-content/60">
                    Select a future date and time. Students must submit before this deadline.
                  </span>
                </label>
              </div>

              <!-- Assignment Materials Section -->
              <div class="divider">Assignment Materials (Optional)</div>
              
              <div class="alert alert-info mb-4">
                <i class="fas fa-info-circle"></i>
                <span>Attach files or links to help students with this assignment (e.g., instructions PDF, reference materials, example code)</span>
              </div>

              <!-- File Uploads -->
              <div class="form-control mb-4">
                <label class="label">
                  <span class="label-text font-semibold">
                    <i class="fas fa-file-upload mr-2"></i>Upload Files
                  </span>
                </label>
                <div id="fileUploadsContainer" class="space-y-3">
                  <div class="file-upload-row">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                      <div class="md:col-span-2">
                        <input 
                          type="file" 
                          name="materials" 
                          class="file-input file-input-bordered file-input-primary w-full" 
                          accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.zip"
                        >
                      </div>
                      <div>
                        <input 
                          type="text" 
                          name="material_titles[]" 
                          placeholder="File title (optional)"
                          class="input input-bordered w-full"
                        >
                      </div>
                    </div>
                  </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline mt-2" onclick="addFileUpload()">
                  <i class="fas fa-plus mr-2"></i>Add Another File
                </button>
                <label class="label">
                  <span class="label-text-alt text-base-content/60 break-words text-xs sm:text-sm">Supported: PDF, DOC, DOCX, PPT, PPTX, TXT, ZIP (Max 10MB each)</span>
                </label>
              </div>

              <!-- URL Links -->
              <div class="form-control mb-6">
                <label class="label">
                  <span class="label-text font-semibold">
                    <i class="fas fa-link mr-2"></i>Add Links
                  </span>
                </label>
                <div id="urlLinksContainer" class="space-y-3">
                  <div class="url-link-row">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                      <div class="md:col-span-2">
                        <input 
                          type="url" 
                          name="material_urls[]" 
                          placeholder="https://example.com/resource"
                          class="input input-bordered w-full"
                        >
                      </div>
                      <div>
                        <input 
                          type="text" 
                          name="url_titles[]" 
                          placeholder="Link title (optional)"
                          class="input input-bordered w-full"
                        >
                      </div>
                    </div>
                  </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline mt-2" onclick="addUrlLink()">
                  <i class="fas fa-plus mr-2"></i>Add Another Link
                </button>
                <label class="label">
                  <span class="label-text-alt text-base-content/60">External resources, documentation, tutorials, etc.</span>
                </label>
              </div>

              <div class="divider"></div>

              <!-- Upload Progress -->
              <div id="assignmentUploadProgress" class="hidden mb-4">
                <div class="flex justify-between text-sm mb-1">
                  <span class="font-medium">Uploading files...</span>
                  <span id="assignmentUploadPercentage">0%</span>
                </div>
                <progress id="assignmentUploadProgressBar" class="progress progress-primary w-full" value="0" max="100"></progress>
                <div class="text-xs text-base-content opacity-60 mt-1">
                  <span id="assignmentUploadedSize">0 MB</span> / <span id="assignmentTotalSize">0 MB</span>
                </div>
              </div>

              <!-- Submit Buttons -->
              <div class="flex gap-3">
                <button type="submit" id="createAssignmentBtn" class="btn btn-primary" style="padding-left: 1.5rem; padding-right: 1.5rem;">
                  <i class="fas fa-save mr-2"></i>Create Assignment
                </button>
                <a href="/teacher/courses/<%= course.id %>" class="btn btn-outline" style="background-color: #ef4444; color: white; border-color: #ef4444; padding-left: 1.5rem; padding-right: 1.5rem;">
                  <i class="fas fa-times mr-2"></i>Cancel
                </a>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Guidelines Sidebar (1/3 width) -->
      <div class="lg:col-span-1">
        <!-- Tips Card -->
        <div class="card bg-base-100 shadow-xl mb-6">
          <div class="card-body">
            <h3 class="font-semibold text-lg mb-3">
              <i class="fas fa-lightbulb mr-2 text-warning"></i>Tips
            </h3>
            <ul class="text-sm space-y-2 text-base-content/80">
              <li class="flex items-start gap-2">
                <i class="fas fa-check-circle text-success mt-1"></i>
                <span>Use clear, descriptive titles</span>
              </li>
              <li class="flex items-start gap-2">
                <i class="fas fa-check-circle text-success mt-1"></i>
                <span>Provide detailed instructions in the description</span>
              </li>
              <li class="flex items-start gap-2">
                <i class="fas fa-check-circle text-success mt-1"></i>
                <span>Set realistic deadlines</span>
              </li>
              <li class="flex items-start gap-2">
                <i class="fas fa-check-circle text-success mt-1"></i>
                <span>Deadline must be in the future</span>
              </li>
            </ul>
          </div>
        </div>

        <!-- Important Notes Card -->
        <div class="card bg-base-200 shadow-xl">
          <div class="card-body">
            <h3 class="font-semibold text-lg mb-3">
              <i class="fas fa-exclamation-triangle mr-2 text-warning"></i>Important
            </h3>
            <ul class="text-sm space-y-2 text-base-content/70">
              <li class="flex items-start gap-2">
                <i class="fas fa-info-circle text-info mt-1"></i>
                <span>Students cannot submit after the deadline</span>
              </li>
              <li class="flex items-start gap-2">
                <i class="fas fa-info-circle text-info mt-1"></i>
                <span>You can edit the deadline later if needed</span>
              </li>
              <li class="flex items-start gap-2">
                <i class="fas fa-info-circle text-info mt-1"></i>
                <span>All students enrolled in this course will see the assignment</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%- include('../shared/footer') %>

  <script>
    // Add file upload row
    function addFileUpload() {
      const container = document.getElementById('fileUploadsContainer');
      const newRow = document.createElement('div');
      newRow.className = 'file-upload-row';
      newRow.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="md:col-span-2">
            <input 
              type="file" 
              name="materials" 
              class="file-input file-input-bordered file-input-primary w-full" 
              accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.zip"
            >
          </div>
          <div class="flex gap-2">
            <input 
              type="text" 
              name="material_titles[]" 
              placeholder="File title (optional)"
              class="input input-bordered w-full"
            >
            <button type="button" class="btn btn-error btn-sm" onclick="this.closest('.file-upload-row').remove()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      `;
      container.appendChild(newRow);
    }

    // Add URL link row
    function addUrlLink() {
      const container = document.getElementById('urlLinksContainer');
      const newRow = document.createElement('div');
      newRow.className = 'url-link-row';
      newRow.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="md:col-span-2">
            <input 
              type="url" 
              name="material_urls[]" 
              placeholder="https://example.com/resource"
              class="input input-bordered w-full"
            >
          </div>
          <div class="flex gap-2">
            <input 
              type="text" 
              name="url_titles[]" 
              placeholder="Link title (optional)"
              class="input input-bordered w-full"
            >
            <button type="button" class="btn btn-error btn-sm" onclick="this.closest('.url-link-row').remove()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      `;
      container.appendChild(newRow);
    }
  
    // Initialize Flatpickr for beautiful datetime picker
    document.addEventListener('DOMContentLoaded', function() {
      const deadlineInput = document.getElementById('deadlineInput');
      
      // Calculate minimum date (current time + 10 minutes)
      const now = new Date();
      now.setMinutes(now.getMinutes() + 10);
      
      // Calculate default date (1 week from now at 11:59 PM)
      const oneWeekLater = new Date();
      oneWeekLater.setDate(oneWeekLater.getDate() + 7);
      oneWeekLater.setHours(23, 59, 0, 0);
      
      // Initialize Flatpickr
      flatpickr(deadlineInput, {
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        altInput: true,
        altFormat: "F j, Y at h:i K",
        minDate: now,
        defaultDate: oneWeekLater,
        time_24hr: false,
        theme: "material_blue",
        disableMobile: true,
        minuteIncrement: 1,
        onChange: function(selectedDates, dateStr, instance) {
          // Update the actual input value for form submission
          deadlineInput.value = dateStr;
        }
      });
    });

    /**
     * Show toast notification
     */
    function showToast(message, type = 'error') {
      const toast = document.createElement('div');
      const icon = type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle';
      
      toast.className = `alert alert-${type} fixed top-4 right-4 w-auto max-w-md shadow-lg z-50 animate-slide-in`;
      toast.innerHTML = `
        <i class="fas fa-${icon}"></i>
        <span class="text-sm sm:text-base">${message}</span>
      `;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    // Form validation and upload progress
    document.getElementById('assignmentForm').addEventListener('submit', function(e) {
      const deadlineInput = document.getElementById('deadlineInput');
      const deadline = new Date(deadlineInput.value);
      const now = new Date();
      
      if (!deadlineInput.value || deadline <= now) {
        e.preventDefault();
        
        // Format the current date/time for user-friendly message
        const currentDateTime = now.toLocaleString('en-US', {
          month: '2-digit',
          day: '2-digit', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          hour12: true
        });
        
        showToast(`Deadline must be in the future!<br><small>Current time: ${currentDateTime}</small>`, 'error');
        deadlineInput.focus();
        return false;
      }

      // Check if any files are selected
      const fileInputs = this.querySelectorAll('input[type="file"]');
      let hasFiles = false;
      let totalSize = 0;
      
      fileInputs.forEach(input => {
        if (input.files && input.files.length > 0) {
          hasFiles = true;
          totalSize += input.files[0].size;
        }
      });
      
      if (!hasFiles) return; // No files, submit normally
      
      e.preventDefault();
      
      const progressDiv = document.getElementById('assignmentUploadProgress');
      const progressBar = document.getElementById('assignmentUploadProgressBar');
      const progressPercentage = document.getElementById('assignmentUploadPercentage');
      const uploadedSizeSpan = document.getElementById('assignmentUploadedSize');
      const totalSizeSpan = document.getElementById('assignmentTotalSize');
      const submitBtn = document.getElementById('createAssignmentBtn');
      
      // Show progress
      progressDiv.classList.remove('hidden');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading loading-spinner"></span> Uploading...';
      
      const fileSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
      totalSizeSpan.textContent = fileSizeMB + ' MB';
      
      // Create FormData
      const formData = new FormData(this);
      
      // Use XMLHttpRequest for progress tracking
      const xhr = new XMLHttpRequest();
      
      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
          const percentComplete = Math.round((e.loaded / e.total) * 100);
          progressBar.value = percentComplete;
          progressPercentage.textContent = percentComplete + '%';
          uploadedSizeSpan.textContent = (e.loaded / (1024 * 1024)).toFixed(2) + ' MB';
        }
      });
      
      xhr.addEventListener('load', () => {
        if (xhr.status === 200 || xhr.status === 302) {
          // Success - follow redirect or reload
          const response = xhr.responseText;
          if (response.includes('Redirecting') || xhr.status === 302) {
            window.location.href = '/teacher/courses/<%= course.id %>';
          } else {
            window.location.reload();
          }
        } else {
          progressDiv.classList.add('hidden');
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Create Assignment';
          showToast('Error uploading files. Please try again.', 'error');
        }
      });
      
      xhr.addEventListener('error', () => {
        progressDiv.classList.add('hidden');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Create Assignment';
        showToast('Network error. Please check your connection and try again.', 'error');
      });
      
      xhr.open('POST', this.action);
      xhr.send(formData);
    });
  </script>
  
  <!-- Flatpickr Library -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</body>
</html>
