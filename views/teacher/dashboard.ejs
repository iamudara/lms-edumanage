<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= pageTitle %> - LMS EduManage</title>
    <link href="/css/output.css" rel="stylesheet" />
    <link href="/css/custom.css" rel="stylesheet" />
    <link href="/css/teacher-theme.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <%- include('../shared/navbar') %>

    <div class="container mx-auto px-4 py-4 sm:py-8">
      <!-- Page Header -->
      <div class="mb-6 sm:mb-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-base-content mb-2">
          <i class="fas fa-chalkboard-teacher mr-2"></i
          ><span class="hidden xs:inline">Teacher </span>Dashboard
        </h1>
        <p class="text-sm sm:text-base text-base-content/70">
          Welcome back, <%= user.full_name %>!
        </p>
      </div>

      <!-- Statistics Cards -->
      <div
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8"
      >
        <!-- My Courses -->
        <div class="stats-card stat-card-gradient-primary">
          <div class="stat">
            <div class="stat-figure text-white/50">
              <i class="fas fa-book text-4xl"></i>
            </div>
            <div class="stat-title text-white/80">My Courses</div>
            <div class="stat-value text-white"><%= stats.totalCourses %></div>
            <div class="stat-desc text-white/60">
              Total courses teaching
            </div>
          </div>
        </div>

        <!-- Active Assignments -->
        <div class="stats-card stat-card-gradient-secondary">
          <div class="stat">
            <div class="stat-figure text-white/50">
              <i class="fas fa-clipboard-check text-4xl"></i>
            </div>
            <div class="stat-title text-white/80">
              Active Assignments
            </div>
            <div class="stat-value text-white"><%= stats.activeAssignments %></div>
            <div class="stat-desc text-white/60">
              Currently open assignments
            </div>
          </div>
        </div>

        <!-- Submissions Today -->
        <div class="stats-card stat-card-gradient-accent">
          <div class="stat">
            <div class="stat-figure text-white/50">
              <i class="fas fa-calendar-day text-4xl"></i>
            </div>
            <div class="stat-title text-white/80">
              Submissions Today
            </div>
            <div class="stat-value text-white"><%= stats.submissionsToday %></div>
            <div class="stat-desc text-white/60">
              New submissions received today
            </div>
          </div>
        </div>

        <!-- Average Submission Rate -->
        <div class="stats-card stat-card-gradient-info">
          <div class="stat">
            <div class="stat-figure text-white/50">
              <i class="fas fa-chart-line text-4xl"></i>
            </div>
            <div class="stat-title text-white/80">
              Avg Submission Rate
            </div>
            <div class="stat-value text-white"><%= stats.avgSubmissionRate %>%</div>
            <div class="stat-desc text-white/60">
              Students submitting on time
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8">
        <!-- My Courses Section (2/3 width) -->
        <div class="lg:col-span-2">
          <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
              <div
                class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4"
              >
                <h2 class="card-title text-xl sm:text-2xl">
                  <i class="fas fa-book-open mr-2"></i>My Courses
                  <span class="badge badge-secondary badge-sm sm:badge-md"
                    >Recently Updated</span
                  >
                </h2>
                <a
                  href="/teacher/courses/create"
                  class="btn btn-primary btn-sm w-full sm:w-auto"
                >
                  <i class="fas fa-plus mr-2"></i>Create Course
                </a>
              </div>
              <% if (totalAllCourses > courses.length) { %>
              <p class="text-sm text-base-content/70 mb-4">
                Showing <%= courses.length %> of <%= totalAllCourses %> courses
                <a href="/teacher/courses" class="link link-primary ml-1"
                  >View all â†’</a
                >
              </p>
              <% } %> <% if (courses.length === 0) { %>
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <span
                  >You haven't created any courses yet. Click "Create Course" to
                  get started!</span
                >
              </div>
              <% } else { %>
              <div class="space-y-4">
                <% courses.forEach(course => {
  // Calculate enrolled students for this course
  let enrolledStudents = 0;
  course.BatchEnrollments.forEach(enrollment => {
    enrolledStudents += enrollment.batch.students.length;
  });
  const assignmentCount = course.Assignments.length;
%>
                <div
                  class="course-card"
                  onclick="window.location.href='/teacher/courses/<%= course.id %>'"
                >
                  <div class="course-card-body">
                    <div class="flex flex-col gap-4">
                      <div class="flex-1 min-w-0 w-full">
                        <h3
                          class="card-title text-base sm:text-lg flex-wrap gap-2"
                        >
                          <span class="course-badge"><%= course.code %></span>
                          <span class="truncate"><%= course.title %></span>
                        </h3>
                        <p
                          class="text-sm sm:text-base text-base-content/70 mt-2 line-clamp-2"
                        >
                          <%= course.description || 'No description available'
                          %>
                        </p>

                        <div class="flex flex-wrap gap-2 mt-3">
                          <div class="badge badge-outline badge-sm">
                            <i class="fas fa-users mr-1"></i>
                            <span><%= enrolledStudents %></span>
                            <span class="hidden sm:inline ml-1">Students</span>
                          </div>
                          <div class="badge badge-outline badge-sm">
                            <i class="fas fa-clipboard-list mr-1"></i>
                            <span><%= assignmentCount %></span>
                            <span class="hidden sm:inline ml-1"
                              >Assignments</span
                            >
                          </div>
                          <div class="badge badge-outline badge-sm">
                            <i class="fas fa-layer-group mr-1"></i>
                            <span><%= course.BatchEnrollments.length %></span>
                            <span class="hidden sm:inline ml-1">Batches</span>
                          </div>
                        </div>
                      </div>

                      <div class="grid grid-cols-3 gap-2 w-full">
                        <a
                          href="/teacher/courses/<%= course.id %>/assignments/create"
                          class="btn btn-xs sm:btn-sm btn-primary"
                          onclick="event.stopPropagation();"
                          title="New Assignment"
                        >
                          <i class="fas fa-plus"></i>
                          <span class="hidden sm:inline ml-1">Assignment</span>
                        </a>
                        <a
                          href="/teacher/courses/<%= course.id %>/materials"
                          class="btn btn-xs sm:btn-sm btn-secondary"
                          onclick="event.stopPropagation();"
                          title="Materials"
                        >
                          <i class="fas fa-file-alt"></i>
                          <span class="hidden sm:inline ml-1">Materials</span>
                        </a>
                        <a
                          href="/teacher/courses/<%= course.id %>/grades"
                          class="btn btn-xs sm:btn-sm btn-accent"
                          onclick="event.stopPropagation();"
                          title="Grades"
                        >
                          <i class="fas fa-chart-bar"></i>
                          <span class="hidden sm:inline ml-1">Grades</span>
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
                <% }) %>
              </div>
              <% } %>
            </div>
          </div>
        </div>

        <!-- Recent Activity Section (1/3 width) -->
        <div class="lg:col-span-1">
          <div class="card bg-base-100 shadow-xl">
            <div class="course-card-body">
              <h2 class="card-title text-xl sm:text-2xl mb-4">
                <i class="fas fa-clock mr-2"></i>Recent Activity
              </h2>

              <% if (recentSubmissions.length === 0) { %>
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <span>No recent submissions</span>
              </div>
              <% } else { %>
              <div class="space-y-3">
                <% recentSubmissions.forEach(submission => { %>
                <div
                  class="card bg-base-200 hover:bg-base-300 transition-colors"
                >
                  <div class="card-body p-4">
                    <div class="flex items-start gap-3">
                      <div class="avatar">
                        <div
                          class="w-10 h-10 rounded-full bg-primary flex items-center justify-center"
                        >
                          <span
                            class="text-primary-content text-sm font-semibold"
                            ><%= submission.student.full_name.charAt(0) %></span
                          >
                        </div>
                      </div>

                      <div class="flex-1 min-w-0">
                        <p class="font-semibold text-sm truncate">
                          <%= submission.student.full_name %>
                        </p>
                        <p class="text-xs text-base-content/70 truncate">
                          <%= submission.assignment.course.code %> - <%=
                          submission.assignment.title %>
                        </p>
                        <p class="text-xs text-base-content/50 mt-1">
                          <i class="far fa-clock mr-1"></i>
                          <%= new
                          Date(submission.submitted_at).toLocaleDateString('en-US',
                          { month: 'short', day: 'numeric', hour: '2-digit',
                          minute: '2-digit' }) %>
                        </p>

                        <% if (submission.marks !== null) { %>
                        <div class="badge badge-success badge-sm mt-2">
                          <i class="fas fa-check mr-1"></i>Graded
                        </div>
                        <% } else { %>
                        <div class="badge badge-warning badge-sm mt-2">
                          <i class="fas fa-hourglass-half mr-1"></i>Pending
                        </div>
                        <% } %>
                      </div>
                    </div>

                    <div class="card-actions justify-end mt-3">
                      <a
                        href="/teacher/submissions/<%= submission.id %>/grade"
                        class="btn btn-xs btn-primary"
                      >
                        <% if (submission.marks !== null) { %>
                        <i class="fas fa-eye mr-1"></i>View <% } else { %>
                        <i class="fas fa-edit mr-1"></i>Grade <% } %>
                      </a>
                    </div>
                  </div>
                </div>
                <% }) %>
              </div>
              <% } %> <% if (stats.pendingSubmissions > 5) { %>
              <div class="divider"></div>
              <a
                href="/teacher/submissions"
                class="btn btn-sm btn-outline btn-block"
              >
                View All Submissions (<%= stats.pendingSubmissions %> pending)
              </a>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <!-- Ongoing Assignments Section -->
      <div class="mt-6 sm:mt-8">
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body p-4 sm:p-6">
            <div class="flex flex-col sm:flex-row sm:items-center gap-2 mb-4">
              <h2 class="card-title text-xl sm:text-2xl">
                <i class="fas fa-tasks mr-2"></i>Ongoing Assignments
              </h2>
              <span class="badge badge-info badge-md"
                ><%= ongoingAssignments.length %> Active</span
              >
            </div>

            <% if (ongoingAssignments.length === 0) { %>
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              <span
                >No ongoing assignments. All deadlines have passed or no
                assignments created yet.</span
              >
            </div>
            <% } else { %>
            <!-- Desktop Table View -->
            <div class="hidden md:block overflow-x-auto">
              <table class="table table-zebra">
                <thead>
                  <tr>
                    <th>Assignment</th>
                    <th>Course</th>
                    <th>Deadline</th>
                    <th>Time Remaining</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% ongoingAssignments.forEach(assignment => { const deadline =
                  new Date(assignment.deadline); const now = new Date(); const
                  diffMs = deadline - now; const diffDays = Math.floor(diffMs /
                  (1000 * 60 * 60 * 24)); const diffHours = Math.floor((diffMs %
                  (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); const diffMinutes
                  = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60)); let
                  timeRemaining = ''; let badgeClass = 'badge-success'; if
                  (diffDays > 0) { timeRemaining = diffDays + ' day' + (diffDays
                  > 1 ? 's' : '') + ' ' + diffHours + 'h'; if (diffDays <= 1)
                  badgeClass = 'badge-warning'; } else if (diffHours > 0) {
                  timeRemaining = diffHours + 'h ' + diffMinutes + 'm';
                  badgeClass = 'badge-warning'; } else { timeRemaining =
                  diffMinutes + ' min'; badgeClass = 'badge-error'; } %>
                  <tr>
                    <td>
                      <div class="font-bold"><%= assignment.title %></div>
                      <div class="text-xs text-base-content/60">
                        Max: <%= assignment.max_marks %> marks
                      </div>
                    </td>
                    <td>
                      <span class="badge badge-primary badge-sm"
                        ><%= assignment.course.code %></span
                      >
                      <div class="text-xs text-base-content/70 mt-1">
                        <%= assignment.course.title %>
                      </div>
                    </td>
                    <td>
                      <div class="text-sm">
                        <%= deadline.toLocaleDateString('en-US', { month:
                        'short', day: 'numeric', year: 'numeric' }) %>
                      </div>
                      <div class="text-xs text-base-content/60">
                        <%= deadline.toLocaleTimeString('en-US', { hour:
                        '2-digit', minute: '2-digit' }) %>
                      </div>
                    </td>
                    <td>
                      <span class="badge <%= badgeClass %>"
                        ><%= timeRemaining %></span
                      >
                    </td>
                    <td>
                      <div class="flex gap-2">
                        <a
                          href="/teacher/assignments/<%= assignment.id %>/submissions"
                          class="btn btn-xs btn-primary"
                        >
                          <i class="fas fa-eye mr-1"></i>Submissions
                        </a>
                        <a
                          href="/teacher/courses/<%= assignment.course.id %>/assignments/<%= assignment.id %>/edit"
                          class="btn btn-xs btn-ghost"
                        >
                          <i class="fas fa-edit"></i>
                        </a>
                      </div>
                    </td>
                  </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>

            <!-- Mobile Card View -->
            <div class="md:hidden space-y-3">
              <% ongoingAssignments.forEach(assignment => { const deadline = new
              Date(assignment.deadline); const now = new Date(); const diffMs =
              deadline - now; const diffDays = Math.floor(diffMs / (1000 * 60 *
              60 * 24)); const diffHours = Math.floor((diffMs % (1000 * 60 * 60
              * 24)) / (1000 * 60 * 60)); const diffMinutes = Math.floor((diffMs
              % (1000 * 60 * 60)) / (1000 * 60)); let timeRemaining = ''; let
              badgeClass = 'badge-success'; if (diffDays > 0) { timeRemaining =
              diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ' + diffHours +
              'h'; if (diffDays <= 1) badgeClass = 'badge-warning'; } else if
              (diffHours > 0) { timeRemaining = diffHours + 'h ' + diffMinutes +
              'm'; badgeClass = 'badge-warning'; } else { timeRemaining =
              diffMinutes + ' min'; badgeClass = 'badge-error'; } %>
              <div class="card bg-base-200 border border-base-300">
                <div class="card-body p-4">
                  <div class="flex justify-between items-start mb-2">
                    <h3 class="font-bold text-base"><%= assignment.title %></h3>
                    <span class="badge <%= badgeClass %> badge-sm"
                      ><%= timeRemaining %></span
                    >
                  </div>

                  <div class="space-y-2 text-sm">
                    <div class="flex items-center gap-2">
                      <span class="badge badge-primary badge-sm"
                        ><%= assignment.course.code %></span
                      >
                      <span class="text-base-content/70 truncate"
                        ><%= assignment.course.title %></span
                      >
                    </div>

                    <div class="flex items-center gap-2 text-base-content/60">
                      <i class="fas fa-calendar-alt"></i>
                      <span
                        ><%= deadline.toLocaleDateString('en-US', { month:
                        'short', day: 'numeric' }) %> at <%=
                        deadline.toLocaleTimeString('en-US', { hour: '2-digit',
                        minute: '2-digit' }) %></span
                      >
                    </div>

                    <div class="flex items-center gap-2 text-base-content/60">
                      <i class="fas fa-star"></i>
                      <span>Max: <%= assignment.max_marks %> marks</span>
                    </div>
                  </div>

                  <div class="grid grid-cols-2 gap-2 mt-3">
                    <a
                      href="/teacher/assignments/<%= assignment.id %>/submissions"
                      class="btn btn-xs btn-primary"
                    >
                      <i class="fas fa-eye mr-1"></i>Submissions
                    </a>
                    <a
                      href="/teacher/courses/<%= assignment.course.id %>/assignments/<%= assignment.id %>/edit"
                      class="btn btn-xs btn-outline"
                    >
                      <i class="fas fa-edit mr-1"></i>Edit
                    </a>
                  </div>
                </div>
              </div>
              <% }); %>
            </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <%- include('../shared/footer') %>
  </body>
</html>
