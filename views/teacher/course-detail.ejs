<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= pageTitle %> - LMS EduManage</title>
  <link href="/css/output.css" rel="stylesheet">
  <link href="/css/custom.css" rel="stylesheet">
  <link href="/css/teacher-theme.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <%- include('../shared/navbar') %>

  <div class="container mx-auto px-4 py-4 sm:py-8">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs mb-4 sm:mb-6">
      <ul>
        <li><a href="/teacher/dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
        <li><a href="/teacher/courses"><i class="fas fa-book"></i> Courses</a></li>
        <li><i class="fas fa-graduation-cap"></i> <%= course.title %></li>
      </ul>
    </div>

    <!-- Course Header -->
    <div class="card bg-gradient-to-r from-[#1e40af] to-[#3b82f6] text-white shadow-xl mb-6">
      <div class="card-body p-4 sm:p-6">
        <div class="flex justify-between items-start gap-2">
          <div class="flex-1">
            <div class="badge badge-outline text-white/90 border-white/40 mb-2 sm:mb-3"><%= course.code %></div>
            <h1 class="text-xl sm:text-3xl lg:text-4xl font-bold mb-2 text-white"><%= course.title %></h1>
            <p class="text-white/80 text-sm sm:text-base lg:text-lg"><%= course.description %></p>
          </div>
          <div class="dropdown dropdown-end flex-shrink-0">
            <label tabindex="0" class="btn btn-ghost text-white hover:bg-white/10">
              <i class="fas fa-ellipsis-v text-xl"></i>
            </label>
            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52 text-base-content">
              <li><a href="/teacher/courses/<%= course.id %>/materials"><i class="fas fa-file-alt"></i>Manage Materials</a></li>
              <li><a href="/teacher/courses/<%= course.id %>/assignments/create"><i class="fas fa-tasks"></i>Create Assignment</a></li>
              <li><a href="/teacher/courses/<%= course.id %>/grades"><i class="fas fa-chart-bar"></i>Manage Grades</a></li>
            </ul>
          </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-3 gap-2 sm:gap-4 mt-4 sm:mt-6">
          <div class="stat bg-white/10 rounded-lg p-2 sm:p-4 border border-white/10 backdrop-blur-sm">
            <div class="stat-title text-white/70 text-xs sm:text-sm">Batches</div>
            <div class="stat-value text-white text-lg sm:text-2xl lg:text-3xl"><%= enrolledBatches.length %></div>
          </div>
          <div class="stat bg-white/10 rounded-lg p-2 sm:p-4 border border-white/10 backdrop-blur-sm">
            <div class="stat-title text-white/70 text-xs sm:text-sm">Students</div>
            <div class="stat-value text-white text-lg sm:text-2xl lg:text-3xl"><%= totalStudents %></div>
          </div>
          <div class="stat bg-white/10 rounded-lg p-2 sm:p-4 border border-white/10 backdrop-blur-sm">
            <div class="stat-title text-white/70 text-xs sm:text-sm">Assignments</div>
            <div class="stat-value text-white text-lg sm:text-2xl lg:text-3xl"><%= course.Assignments.length %></div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Main Content (2/3 width) -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Assignments Section -->
        <div class="card bg-base-100 shadow-xl">
          <!-- ... assignments content ... -->
          <div class="card-body">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
              <h2 class="card-title text-lg sm:text-xl lg:text-2xl">
                <i class="fas fa-clipboard-list mr-2"></i>Assignments
              </h2>
              <a href="/teacher/courses/<%= course.id %>/assignments/create" class="btn btn-primary btn-sm w-full sm:w-auto">
                <i class="fas fa-plus mr-1"></i>
                <span class="hidden xs:inline">Create </span>Assignment
              </a>
            </div>
            <% if (course.Assignments.length === 0) { %>
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <span>No assignments created yet for this course.</span>
              </div>
            <% } else { %>
              <div class="space-y-3">
                <% course.Assignments.forEach(assignment => { 
                  const submissionCount = assignment.Submissions.length;
                  const gradedCount = assignment.Submissions.filter(s => s.marks !== null).length;
                  const pendingCount = submissionCount - gradedCount;
                  const isOverdue = new Date(assignment.deadline) < new Date();
                %>
                  <div class="card bg-base-200 shadow-lg hover:shadow-xl transition-all duration-300 border border-base-300 group">
                    <div class="card-body p-4 sm:p-5">
                      <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
                        <div class="flex-1 w-full sm:w-auto">
                          <div class="flex items-center gap-2 mb-1">
                            <h3 class="font-bold text-lg sm:text-xl text-primary group-hover:text-primary-focus transition-colors">
                              <%= assignment.title %>
                            </h3>
                            <% if (isOverdue) { %>
                              <div class="badge badge-error badge-sm">Overdue</div>
                            <% } else { %>
                              <div class="badge badge-success badge-sm text-white">Active</div>
                            <% } %>
                          </div>
                          
                          <p class="text-sm text-base-content/80 mb-3 line-clamp-2"><%= assignment.description %></p>
                          
                          <div class="flex flex-wrap items-center gap-3 text-sm text-base-content/70">
                            <div class="flex items-center gap-1.5 bg-base-200 px-2.5 py-1 rounded-full">
                              <i class="far fa-calendar-alt text-primary"></i>
                              <span>Due: <%= new Date(assignment.deadline).toLocaleDateString('en-US', {
                                month: 'short',
                                day: 'numeric',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                              }) %></span>
                            </div>
                            
                            <div class="flex items-center gap-3 ml-1">
                              <span class="tooltip" data-tip="Total Submissions">
                                <i class="fas fa-file-alt text-info mr-1"></i><%= submissionCount %>
                              </span>
                              <span class="tooltip" data-tip="Graded">
                                <i class="fas fa-check-circle text-success mr-1"></i><%= gradedCount %>
                              </span>
                              <% if (pendingCount > 0) { %>
                                <span class="tooltip" data-tip="Pending Review">
                                  <i class="fas fa-clock text-warning mr-1"></i><%= pendingCount %>
                                </span>
                              <% } %>
                            </div>
                          </div>

                          <!-- Assignment Materials -->
                          <% if (assignment.materials && assignment.materials.length > 0) { %>
                            <div class="mt-4 p-3 bg-base-200/50 rounded-xl border border-base-200">
                              <h4 class="text-xs font-bold text-base-content/60 uppercase tracking-wider mb-2 flex items-center gap-1.5">
                                <i class="fas fa-paperclip"></i>Attached Materials
                              </h4>
                              <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <% assignment.materials.forEach(material => { %>
                                  <a href="<%= material.url %>" target="_blank" class="flex items-center gap-2 p-2 rounded-lg hover:bg-white hover:shadow-sm transition-all group/item text-sm">
                                    <% if (material.type === 'file') { %>
                                      <div class="w-8 h-8 rounded-full bg-error/10 flex items-center justify-center flex-shrink-0 text-error group-hover/item:bg-error group-hover/item:text-white transition-colors">
                                        <i class="fas fa-file-pdf"></i>
                                      </div>
                                    <% } else { %>
                                      <div class="w-8 h-8 rounded-full bg-info/10 flex items-center justify-center flex-shrink-0 text-info group-hover/item:bg-info group-hover/item:text-white transition-colors">
                                        <i class="fas fa-link"></i>
                                      </div>
                                    <% } %>
                                    <span class="truncate font-medium text-base-content/80 group-hover/item:text-primary"><%= material.title %></span>
                                  </a>
                                <% }) %>
                              </div>
                            </div>
                          <% } %>
                        </div>

                        <div class="flex flex-row sm:flex-col gap-2 w-full sm:w-auto mt-2 sm:mt-0">
                          <a href="/teacher/assignments/<%= assignment.id %>/submissions" class="btn btn-sm btn-primary rounded-full shadow-sm hover:shadow-md border-none flex-1 sm:flex-none w-full sm:w-24">
                            <i class="fas fa-eye"></i> View
                          </a>
                          <a href="/teacher/assignments/<%= assignment.id %>/edit" class="btn btn-sm btn-info text-white rounded-full shadow-sm hover:shadow-md border-none flex-1 sm:flex-none w-full sm:w-24">
                            <i class="fas fa-edit"></i> Edit
                          </a>
                          <button onclick="deleteAssignment('<%= assignment.id %>', '<%= assignment.title %>')" class="btn btn-sm btn-error text-white rounded-full shadow-sm hover:shadow-md border-none flex-1 sm:flex-none w-full sm:w-24">
                            <i class="fas fa-trash"></i> Delete
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                <% }) %>
              </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Sidebar (1/3 width) -->
      <div class="space-y-6">
        <!-- Enrolled Batches -->
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <h2 class="card-title text-xl mb-4">
              <i class="fas fa-layer-group mr-2"></i>Enrolled Batches
            </h2>

            <% if (enrolledBatches.length === 0) { %>
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <span>No batches enrolled yet. Contact admin to enroll batches.</span>
              </div>
            <% } else { %>
              <div class="space-y-2">
                <% enrolledBatches.forEach(batch => { %>
                  <div class="flex justify-between items-center p-3 bg-base-200 rounded-lg">
                    <div>
                      <div class="font-semibold"><%= batch.name %></div>
                      <div class="text-sm text-base-content/70"><%= batch.code %></div>
                    </div>
                    <div class="badge badge-primary"><%= batch.studentsCount %> students</div>
                  </div>
                <% }) %>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <h2 class="card-title text-xl mb-4">
              <i class="fas fa-bolt mr-2"></i>Quick Actions
            </h2>
            
            <div class="space-y-2">
              <div class="flex flex-row gap-1">
                <a href="/teacher/courses/<%= course.id %>/materials" class="btn btn-glass-custom btn-sm flex-1 flex flex-row items-center justify-center gap-1 h-auto py-2 px-1 lg:px-2 whitespace-nowrap text-xs sm:text-sm">
                  <i class="fas fa-file-alt"></i>
                  <span>Materials</span>
                </a>
                <a href="/teacher/courses/<%= course.id %>/assignments/create" class="btn btn-glass-custom btn-sm flex-1 flex flex-row items-center justify-center gap-1 h-auto py-2 px-1 lg:px-2 whitespace-nowrap text-xs sm:text-sm">
                  <i class="fas fa-plus-circle"></i>
                  <span>Assignment</span>
                </a>
                <a href="/teacher/courses/<%= course.id %>/grades" class="btn btn-glass-custom btn-sm flex-1 flex flex-row items-center justify-center gap-1 h-auto py-2 px-1 lg:px-2 whitespace-nowrap text-xs sm:text-sm">
                  <i class="fas fa-chart-bar"></i>
                  <span>Grades</span>
                </a>
              </div>
              <a href="/teacher/courses" class="btn btn-ghost btn-block justify-start">
                <i class="fas fa-arrow-left mr-2"></i>Back to Courses
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**
     * Delete assignment with confirmation
     */
    async function deleteAssignment(assignmentId, assignmentTitle) {
      // Set modal content
      document.getElementById('deleteModalTitle').textContent = `"${assignmentTitle}"`;
      document.getElementById('deleteAssignmentId').value = assignmentId;
      
      // Show modal
      document.getElementById('deleteConfirmModal').showModal();
    }

    /**
     * Confirm delete action
     */
    async function confirmDelete() {
      const assignmentId = document.getElementById('deleteAssignmentId').value;
      const modal = document.getElementById('deleteConfirmModal');
      const deleteBtn = document.getElementById('confirmDeleteBtn');
      
      // Show loading state
      deleteBtn.disabled = true;
      deleteBtn.innerHTML = '<span class="loading loading-spinner"></span> Deleting...';

      try {
        const response = await fetch(`/teacher/assignments/${assignmentId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();

        if (result.success) {
          // Close modal and redirect
          modal.close();
          window.location.href = result.redirectUrl;
        } else {
          // Show error toast
          showToast('Error: ' + result.message, 'error');
          deleteBtn.disabled = false;
          deleteBtn.innerHTML = '<i class="fas fa-trash mr-2"></i>Delete Assignment';
        }
      } catch (error) {
        console.error('Delete error:', error);
        showToast('Error deleting assignment. Please try again.', 'error');
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = '<i class="fas fa-trash mr-2"></i>Delete Assignment';
      }
    }

    /**
     * Show toast notification
     */
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `alert alert-${type} fixed top-4 right-4 w-auto max-w-md shadow-lg z-50`;
      toast.innerHTML = `
        <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
        <span>${message}</span>
      `;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>

  <!-- Delete Confirmation Modal -->
  <dialog id="deleteConfirmModal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">
        <i class="fas fa-exclamation-triangle text-error mr-2"></i>
        Delete Assignment
      </h3>
      
      <p class="mb-4">
        Are you sure you want to delete <strong id="deleteModalTitle"></strong>?
      </p>
      
      <div class="bg-error/10 border border-error/20 rounded-lg p-4 mb-6">
        <p class="font-semibold text-error mb-2">
          <i class="fas fa-warning mr-2"></i>This will permanently delete:
        </p>
        <ul class="list-disc list-inside text-sm space-y-1 text-base-content/80">
          <li>The assignment</li>
          <li>All assignment materials</li>
          <li>All student submissions</li>
          <li>All grades for this assignment</li>
        </ul>
        <p class="text-sm font-semibold text-error mt-3">
          <i class="fas fa-ban mr-2"></i>This action cannot be undone.
        </p>
      </div>
      
      <input type="hidden" id="deleteAssignmentId">
      
      <div class="modal-action">
        <form method="dialog" class="flex gap-2">
          <button type="button" class="btn btn-primary" onclick="document.getElementById('deleteConfirmModal').close()">
            <i class="fas fa-times mr-2"></i>Cancel
          </button>
          <button type="button" id="confirmDeleteBtn" class="btn btn-error" onclick="confirmDelete()">
            <i class="fas fa-trash mr-2"></i>Delete Assignment
          </button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <%- include('../shared/footer') %>
</body>
</html>
