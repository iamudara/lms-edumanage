<%- include('../layouts/main', { 
  title: title,
  body: `
    <!-- Change Password Content -->
    <div class="container mx-auto px-4 py-8">
      <!-- Page Header -->
      <div class="mb-8">
        <div class="flex items-center gap-3 mb-2">
          <div class="avatar placeholder">
            <div class="bg-primary text-primary-content rounded-full w-12">
              <i class="fas fa-key text-xl"></i>
            </div>
          </div>
          <div>
            <h1 class="text-3xl font-bold text-base-content">Change Password</h1>
            <p class="text-base-content/70">Update your account password</p>
          </div>
        </div>
        
        <!-- Breadcrumbs -->
        <div class="text-sm breadcrumbs">
          <ul>
            <li><a href="/" class="text-primary"><i class="fas fa-home mr-1"></i>Dashboard</a></li>
            <li class="text-base-content/70">Change Password</li>
          </ul>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Form Card -->
        <div class="lg:col-span-2">
          <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
              <!-- Flash Messages -->
              ${error ? `
              <div class="alert alert-error shadow-lg mb-4">
                <div>
                  <i class="fas fa-exclamation-circle"></i>
                  <span>${error}</span>
                </div>
              </div>
              ` : ''}

              ${success ? `
              <div class="alert alert-success shadow-lg mb-4">
                <div>
                  <i class="fas fa-check-circle"></i>
                  <span>${success}</span>
                </div>
              </div>
              ` : ''}

              <!-- Form Title -->
              <h2 class="card-title mb-6">
                <i class="fas fa-lock mr-2 text-primary"></i>
                Password Security
              </h2>

              <!-- Change Password Form -->
              <form action="/auth/change-password" method="POST" id="changePasswordForm" class="space-y-4">
                
                <!-- Current Password -->
                <div class="form-control">
                  <label class="label" for="currentPassword">
                    <span class="label-text font-medium">
                      <i class="fas fa-shield-alt mr-2 text-warning"></i>Current Password
                    </span>
                    <span class="label-text-alt text-error">Required</span>
                  </label>
                  <div class="relative">
                    <input 
                      type="password" 
                      id="currentPassword"
                      name="currentPassword" 
                      placeholder="Enter your current password" 
                      class="input input-bordered w-full pr-10" 
                      required
                      autocomplete="current-password"
                      autofocus
                    />
                    <button 
                      type="button" 
                      class="btn btn-ghost btn-sm absolute right-2 top-1/2 -translate-y-1/2"
                      onclick="togglePassword('currentPassword')"
                    >
                      <i class="fas fa-eye" id="currentPassword-icon"></i>
                    </button>
                  </div>
                </div>

                <!-- Divider -->
                <div class="divider">New Password Details</div>

                <!-- New Password -->
                <div class="form-control">
                  <label class="label" for="newPassword">
                    <span class="label-text font-medium">
                      <i class="fas fa-key mr-2 text-primary"></i>New Password
                    </span>
                    <span class="label-text-alt text-error">Required</span>
                  </label>
                  <div class="relative">
                    <input 
                      type="password" 
                      id="newPassword"
                      name="newPassword" 
                      placeholder="Enter new password (min 6 characters)" 
                      class="input input-bordered w-full pr-10" 
                      required
                      autocomplete="new-password"
                      minlength="6"
                    />
                    <button 
                      type="button" 
                      class="btn btn-ghost btn-sm absolute right-2 top-1/2 -translate-y-1/2"
                      onclick="togglePassword('newPassword')"
                    >
                      <i class="fas fa-eye" id="newPassword-icon"></i>
                    </button>
                  </div>
                  <label class="label">
                    <span class="label-text-alt text-base-content/60">
                      <i class="fas fa-info-circle mr-1"></i>Minimum 6 characters
                    </span>
                  </label>
                  
                  <!-- Password Strength Indicator -->
                  <div class="mt-2" id="passwordStrength" style="display: none;">
                    <div class="flex items-center gap-2">
                      <span class="text-xs text-base-content/70">Strength:</span>
                      <progress class="progress w-full" value="0" max="100" id="strengthBar"></progress>
                      <span class="text-xs font-medium" id="strengthText"></span>
                    </div>
                  </div>
                </div>

                <!-- Confirm New Password -->
                <div class="form-control">
                  <label class="label" for="confirmPassword">
                    <span class="label-text font-medium">
                      <i class="fas fa-check-double mr-2 text-success"></i>Confirm New Password
                    </span>
                    <span class="label-text-alt text-error">Required</span>
                  </label>
                  <div class="relative">
                    <input 
                      type="password" 
                      id="confirmPassword"
                      name="confirmPassword" 
                      placeholder="Re-enter new password" 
                      class="input input-bordered w-full pr-10" 
                      required
                      autocomplete="new-password"
                      minlength="6"
                    />
                    <button 
                      type="button" 
                      class="btn btn-ghost btn-sm absolute right-2 top-1/2 -translate-y-1/2"
                      onclick="togglePassword('confirmPassword')"
                    >
                      <i class="fas fa-eye" id="confirmPassword-icon"></i>
                    </button>
                  </div>
                  <label class="label">
                    <span class="label-text-alt text-base-content/60" id="matchStatus"></span>
                  </label>
                </div>

                <!-- Action Buttons -->
                <div class="form-control mt-8">
                  <div class="flex flex-col sm:flex-row gap-3">
                    <button type="submit" class="btn btn-primary flex-1">
                      <i class="fas fa-save mr-2"></i>
                      Change Password
                    </button>
                    <a href="/" class="btn btn-ghost flex-1">
                      <i class="fas fa-times mr-2"></i>
                      Cancel
                    </a>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Security Tips Sidebar -->
        <div class="lg:col-span-1">
          <div class="card bg-base-200 shadow-lg">
            <div class="card-body">
              <h3 class="card-title text-lg">
                <i class="fas fa-lightbulb text-warning mr-2"></i>
                Security Tips
              </h3>
              
              <div class="space-y-3 text-sm">
                <div class="flex items-start gap-2">
                  <i class="fas fa-check-circle text-success mt-1"></i>
                  <p>Use a strong password with at least 6 characters</p>
                </div>
                
                <div class="flex items-start gap-2">
                  <i class="fas fa-check-circle text-success mt-1"></i>
                  <p>Include uppercase, lowercase, numbers, and symbols</p>
                </div>
                
                <div class="flex items-start gap-2">
                  <i class="fas fa-check-circle text-success mt-1"></i>
                  <p>Avoid using personal information</p>
                </div>
                
                <div class="flex items-start gap-2">
                  <i class="fas fa-check-circle text-success mt-1"></i>
                  <p>Don't reuse passwords from other accounts</p>
                </div>
                
                <div class="flex items-start gap-2">
                  <i class="fas fa-check-circle text-success mt-1"></i>
                  <p>Change your password regularly</p>
                </div>
              </div>

              <div class="divider my-4"></div>

              <div class="alert alert-info shadow-sm">
                <div class="text-xs">
                  <i class="fas fa-info-circle mr-1"></i>
                  Your password is encrypted and stored securely
                </div>
              </div>
            </div>
          </div>

          <!-- User Info Card -->
          <div class="card bg-base-100 shadow-lg mt-6">
            <div class="card-body">
              <h3 class="card-title text-lg">
                <i class="fas fa-user-circle text-primary mr-2"></i>
                Account Info
              </h3>
              
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-base-content/70">Name:</span>
                  <span class="font-medium">${user.full_name}</span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-base-content/70">Username:</span>
                  <span class="font-medium">${user.username}</span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-base-content/70">Email:</span>
                  <span class="font-medium">${user.email}</span>
                </div>
                
                <div class="flex justify-between">
                  <span class="text-base-content/70">Role:</span>
                  <span class="badge badge-${user.role === 'admin' ? 'error' : user.role === 'teacher' ? 'warning' : 'info'} badge-sm">
                    ${user.role.toUpperCase()}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Client-side Validation Script -->
    <script>
      // Toggle password visibility
      function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const icon = document.getElementById(fieldId + '-icon');
        
        if (field.type === 'password') {
          field.type = 'text';
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
        } else {
          field.type = 'password';
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
        }
      }

      // Password strength checker
      const newPasswordField = document.getElementById('newPassword');
      const strengthBar = document.getElementById('strengthBar');
      const strengthText = document.getElementById('strengthText');
      const strengthContainer = document.getElementById('passwordStrength');

      newPasswordField.addEventListener('input', function() {
        const password = this.value;
        
        if (password.length === 0) {
          strengthContainer.style.display = 'none';
          return;
        }
        
        strengthContainer.style.display = 'block';
        
        let strength = 0;
        
        // Length check
        if (password.length >= 6) strength += 20;
        if (password.length >= 8) strength += 10;
        if (password.length >= 12) strength += 10;
        
        // Character variety
        if (/[a-z]/.test(password)) strength += 15;
        if (/[A-Z]/.test(password)) strength += 15;
        if (/[0-9]/.test(password)) strength += 15;
        if (/[^a-zA-Z0-9]/.test(password)) strength += 15;
        
        strengthBar.value = strength;
        
        if (strength < 40) {
          strengthBar.className = 'progress progress-error w-full';
          strengthText.textContent = 'Weak';
          strengthText.className = 'text-xs font-medium text-error';
        } else if (strength < 70) {
          strengthBar.className = 'progress progress-warning w-full';
          strengthText.textContent = 'Medium';
          strengthText.className = 'text-xs font-medium text-warning';
        } else {
          strengthBar.className = 'progress progress-success w-full';
          strengthText.textContent = 'Strong';
          strengthText.className = 'text-xs font-medium text-success';
        }
      });

      // Confirm password match indicator
      const confirmPasswordField = document.getElementById('confirmPassword');
      const matchStatus = document.getElementById('matchStatus');

      function checkPasswordMatch() {
        const newPassword = newPasswordField.value;
        const confirmPassword = confirmPasswordField.value;
        
        if (confirmPassword.length === 0) {
          matchStatus.textContent = '';
          confirmPasswordField.classList.remove('input-error', 'input-success');
          return;
        }
        
        if (newPassword === confirmPassword) {
          matchStatus.innerHTML = '<i class="fas fa-check-circle text-success mr-1"></i>Passwords match';
          matchStatus.className = 'label-text-alt text-success';
          confirmPasswordField.classList.remove('input-error');
          confirmPasswordField.classList.add('input-success');
        } else {
          matchStatus.innerHTML = '<i class="fas fa-times-circle text-error mr-1"></i>Passwords do not match';
          matchStatus.className = 'label-text-alt text-error';
          confirmPasswordField.classList.remove('input-success');
          confirmPasswordField.classList.add('input-error');
        }
      }

      newPasswordField.addEventListener('input', checkPasswordMatch);
      confirmPasswordField.addEventListener('input', checkPasswordMatch);

      // Form validation
      document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = newPasswordField.value;
        const confirmPassword = confirmPasswordField.value;

        // Check all fields filled
        if (!currentPassword || !newPassword || !confirmPassword) {
          e.preventDefault();
          alert('All fields are required');
          return false;
        }

        // Check new password length
        if (newPassword.length < 6) {
          e.preventDefault();
          alert('New password must be at least 6 characters long');
          newPasswordField.focus();
          return false;
        }

        // Check passwords match
        if (newPassword !== confirmPassword) {
          e.preventDefault();
          alert('New password and confirm password do not match');
          confirmPasswordField.focus();
          return false;
        }

        // Check new password is different from current
        if (currentPassword === newPassword) {
          e.preventDefault();
          alert('New password must be different from current password');
          newPasswordField.focus();
          return false;
        }

        return true;
      });

      // Auto-hide alerts after 5 seconds
      setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
          alert.style.transition = 'opacity 0.5s';
          alert.style.opacity = '0';
          setTimeout(function() {
            alert.remove();
          }, 500);
        });
      }, 5000);
    </script>
  `
}) %>
