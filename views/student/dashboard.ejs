<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - LMS EduManage</title>
  <link href="/css/output.css" rel="stylesheet">
  <link href="/css/custom.css" rel="stylesheet">
  <link href="/css/teacher-theme.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-base-200 min-h-screen">
  <%- include('../shared/navbar') %>

  <div class="container mx-auto px-3 sm:px-4 py-4 sm:py-8 max-w-7xl">
    <!-- Page Header -->
    <div class="mb-6 sm:mb-8">
      <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-base-content mb-2">
        <i class="fas fa-user-graduate mr-2"></i>
        <span class="hidden xs:inline">Student </span>Dashboard
      </h1>
      <p class="text-sm sm:text-base text-base-content/70">
        Welcome back, <strong><%= user.full_name %></strong>! Here's your academic overview.
      </p>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
      <!-- My Courses -->
      <div class="stats shadow bg-primary text-primary-content">
        <div class="stat">
          <div class="stat-figure text-white/80">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
          </div>
          <div class="stat-title text-primary-content/80">My Courses</div>
          <div class="stat-value"><%= stats.totalCourses %></div>
          <div class="stat-desc text-primary-content/70">Currently enrolled</div>
        </div>
      </div>

      <!-- To Submit -->
      <div class="stats shadow bg-warning text-warning-content">
        <div class="stat">
          <div class="stat-figure text-white/80">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
          </div>
          <div class="stat-title text-warning-content/80">To Submit</div>
          <div class="stat-value"><%= stats.toSubmit %></div>
          <div class="stat-desc text-warning-content/70">Assignments awaiting submission</div>
        </div>
      </div>

      <!-- Submitted This Week -->
      <div class="stats shadow bg-success text-success-content">
        <div class="stat">
          <div class="stat-figure text-white/80">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="stat-title text-success-content/80">Submitted This Week</div>
          <div class="stat-value"><%= stats.submittedThisWeek %></div>
          <div class="stat-desc text-success-content/70">Recent submissions</div>
        </div>
      </div>

      <!-- Completion Rate -->
      <div class="stats shadow bg-info text-info-content">
        <div class="stat">
          <div class="stat-figure text-white/80">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
          </div>
          <div class="stat-title text-info-content/80">Completion Rate</div>
          <div class="stat-value"><%= stats.completionRate %>%</div>
          <div class="stat-desc text-info-content/70">Of assignments submitted</div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8">
      <!-- Left Column -->
      <div class="space-y-6 sm:space-y-8">
        <!-- Enrolled Courses -->
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body p-4 sm:p-6">
            <h2 class="card-title text-xl sm:text-2xl mb-4">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
              </svg>
              My Courses
              <span class="badge badge-secondary">Recently Updated</span>
            </h2>
            <% if (totalEnrolledCourses > enrolledCourses.length) { %>
              <p class="text-sm text-base-content/70 mb-2">
                Showing <%= enrolledCourses.length %> of <%= totalEnrolledCourses %> enrolled courses
                <a href="/student/courses" class="link link-primary ml-1">View all ‚Üí</a>
              </p>
            <% } %>

            <% if (enrolledCourses.length === 0) { %>
              <div class="alert alert-info">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>You are not enrolled in any courses yet. Contact your administrator.</span>
              </div>
            <% } else { %>
              <div class="space-y-3">
                <% enrolledCourses.forEach(course => { 
                  const primaryTeacher = course.courseTeachers?.find(ct => ct.is_primary)?.teacher;
                %>
                  <div class="card bg-base-200 hover:bg-base-300 transition-colors cursor-pointer">
                    <div class="card-body p-4">
                      <div class="flex justify-between items-start">
                        <div class="flex-1">
                          <h3 class="font-bold text-lg">
                            <%= course.title %>
                            <span class="badge badge-primary badge-sm ml-2"><%= course.code %></span>
                          </h3>
                          <p class="text-sm text-base-content/70 mt-1">
                            üë®‚Äçüè´ <%= primaryTeacher ? primaryTeacher.full_name : 'Unknown' %>
                          </p>
                          <div class="flex gap-4 mt-2 text-xs text-base-content/60">
                            <span>üìù <%= course.Assignments?.length || 0 %> Assignment<%= (course.Assignments?.length || 0) !== 1 ? 's' : '' %></span>
                            <span>üìö <%= course.Materials?.length || 0 %> Material<%= (course.Materials?.length || 0) !== 1 ? 's' : '' %></span>
                          </div>
                        </div>
                        <a href="/student/courses/<%= course.id %>" class="btn btn-xs sm:btn-sm btn-primary" style="border-radius: 9999px;">
                          <i class="fas fa-eye"></i>
                          <span class="hidden sm:inline ml-1">View</span>
                        </a>
                      </div>
                    </div>
                  </div>
                <% }); %>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Recent Grades -->
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body p-4 sm:p-6">
            <h2 class="card-title text-xl sm:text-2xl mb-4">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />
              </svg>
              Recent Scores
            </h2>

            <% if (recentGradedSubmissions.length === 0) { %>
              <div class="alert alert-info">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>No graded assignments yet.</span>
              </div>
            <% } else { %>
              <div class="overflow-x-auto">
                <table class="table table-zebra">
                  <thead>
                    <tr>
                      <th>Assignment</th>
                      <th>Course</th>
                      <th>Score</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% recentGradedSubmissions.forEach(submission => { %>
                      <tr>
                        <td>
                          <div class="font-medium"><%= submission.assignment.title %></div>
                        </td>
                        <td>
                          <div class="text-sm opacity-70"><%= submission.assignment.course.code %></div>
                        </td>
                        <td>
                          <span class="badge badge-lg <%= parseFloat(submission.marks) >= 70 ? 'badge-success' : parseFloat(submission.marks) >= 50 ? 'badge-warning' : 'badge-error' %>">
                            <%= submission.marks %>%
                          </span>
                        </td>
                      </tr>
                    <% }); %>
                  </tbody>
                </table>
              </div>
              <div class="card-actions justify-end mt-4">
                <a href="/student/grades" class="btn btn-sm btn-outline btn-primary w-full sm:w-auto" style="border-radius: 9999px;">
                  <i class="fas fa-chart-bar mr-2"></i>
                  View All Grades
                </a>
              </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="space-y-6 sm:space-y-8">
        <!-- Upcoming Assignments -->
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body p-4 sm:p-6">
            <h2 class="card-title text-xl sm:text-2xl mb-4">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Pending Assignments
            </h2>

            <% if (pendingAssignments.length === 0) { %>
              <div class="alert alert-success">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>All caught up! No pending assignments.</span>
              </div>
            <% } else { %>
              <div class="space-y-3">
                <% pendingAssignments.forEach(assignment => { 
                  const deadline = new Date(assignment.deadline);
                  const now = new Date();
                  const diffMs = deadline - now;
                  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                  const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                  const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                  
                  let timeRemaining = '';
                  let badgeClass = 'badge-success';
                  let isUrgent = false;
                  
                  if (diffDays > 0) {
                    timeRemaining = diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ' + diffHours + 'h';
                    if (diffDays <= 1) {
                      badgeClass = 'badge-warning';
                      isUrgent = true;
                    }
                  } else if (diffHours > 0) {
                    timeRemaining = diffHours + 'h ' + diffMinutes + 'm';
                    badgeClass = 'badge-warning';
                    isUrgent = true;
                  } else {
                    timeRemaining = diffMinutes + ' min';
                    badgeClass = 'badge-error';
                    isUrgent = true;
                  }
                %>
                  <div class="card bg-base-200 <%= isUrgent ? 'border-2 border-error' : '' %>">
                    <div class="card-body p-4">
                      <div class="flex justify-between items-start">
                        <div class="flex-1">
                          <h3 class="font-bold">
                            <%= assignment.title %>
                            <% if (diffDays <= 0 && diffHours < 1) { %>
                              <span class="badge badge-error badge-sm ml-2">URGENT</span>
                            <% } %>
                          </h3>
                          <p class="text-sm text-base-content/70 mt-1">
                            <%= assignment.course.code %> - <%= assignment.course.title %>
                          </p>
                          <div class="flex items-center gap-3 mt-2 text-xs">
                            <span class="text-base-content/60">
                              Due <%= deadline.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %> 
                              at <%= deadline.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %>
                            </span>
                            <span class="badge <%= badgeClass %> badge-sm"><%= timeRemaining %> left</span>
                          </div>
                        </div>
                        <a href="/student/assignments/<%= assignment.id %>" class="btn btn-xs sm:btn-sm <%= isUrgent ? 'btn-error' : 'btn-primary' %>" style="border-radius: 9999px;">
                          <i class="fas fa-paper-plane"></i>
                          <span class="hidden sm:inline ml-1">Submit</span>
                        </a>
                      </div>
                    </div>
                  </div>
                <% }); %>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Quick Links -->
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body p-4 sm:p-6">
            <h2 class="card-title text-xl sm:text-2xl mb-4">
              <i class="fas fa-link"></i>
              Quick Links
            </h2>
            <div class="space-y-2">
              <a href="/student/grades" class="btn btn-outline btn-block justify-start" style="border-radius: 9999px;">
                <i class="fas fa-star"></i>
                View All Grades
              </a>
              <a href="/auth/change-password" class="btn btn-outline btn-block justify-start" style="border-radius: 9999px;">
                <i class="fas fa-key"></i>
                Change Password
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%- include('../shared/footer') %>
</body>
</html>
