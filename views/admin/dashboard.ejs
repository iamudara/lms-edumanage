<!DOCTYPE html>
<html lang="en" data-theme="corporate">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - LMS EduManage</title>
  <link href="/css/output.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-base-200 min-h-screen">
  
  <%- include('../shared/navbar') %>

  <div class="container mx-auto px-4 py-8">
    
    <!-- Page Header -->
    <div class="mb-8">
      <h1 class="text-4xl font-bold text-base-content mb-2">
        üìä Admin Dashboard
      </h1>
      <p class="text-base-content/70">
        Overview of system statistics and recent activity
      </p>
    </div>

    <!-- Statistics Cards Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      
      <!-- Total Users Card (Students + Teachers) -->
      <div class="card bg-primary text-primary-content shadow-lg">
        <div class="card-body">
          <h2 class="card-title text-lg">üë• Total Users</h2>
          <p class="text-4xl font-bold"><%= stats.userCountDisplay %></p>
          <div class="text-sm opacity-80 mt-2">
            <div>Teachers: <%= stats.teacherCount %></div>
            <div>Students: <%= stats.studentCount %></div>
          </div>
        </div>
      </div>

      <!-- Platform Usage - Active Users This Week -->
      <div class="card bg-secondary text-secondary-content shadow-lg">
        <div class="card-body">
          <h2 class="card-title text-lg">üìà Platform Usage</h2>
          <p class="text-4xl font-bold"><%= stats.activeUsersThisWeek %></p>
          <div class="text-sm opacity-80 mt-2">
            Active users this week
          </div>
        </div>
      </div>

      <!-- System Activity - Submissions This Week -->
      <div class="card bg-accent text-accent-content shadow-lg">
        <div class="card-body">
          <h2 class="card-title text-lg">‚ö° System Activity</h2>
          <p class="text-4xl font-bold"><%= stats.submissionsThisWeek %></p>
          <div class="text-sm opacity-80 mt-2">
            Submissions this week
          </div>
        </div>
      </div>

      <!-- New Enrollments - This Year -->
      <div class="card bg-info text-info-content shadow-lg">
        <div class="card-body">
          <h2 class="card-title text-lg">‚ú® New Enrollments</h2>
          <p class="text-4xl font-bold"><%= stats.enrollmentsThisYear %></p>
          <div class="text-sm opacity-80 mt-2">
            Enrolled this year
          </div>
        </div>
      </div>

    </div>

    <!-- Additional Stats Row -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      
      <!-- Assignments Card -->
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
          <h2 class="card-title text-lg">üìù Assignments</h2>
          <p class="text-3xl font-bold text-primary"><%= stats.totalAssignments %></p>
          <div class="text-sm text-base-content/70">
            Total assignments created
          </div>
        </div>
      </div>

      <!-- Submissions Card -->
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
          <h2 class="card-title text-lg">üì§ Submissions</h2>
          <p class="text-3xl font-bold text-secondary"><%= stats.totalSubmissions %></p>
          <div class="text-sm text-base-content/70">
            Graded: <%= stats.gradedSubmissions %>
          </div>
        </div>
      </div>

      <!-- Grades Card -->
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
          <h2 class="card-title text-lg">üéØ Final Grades</h2>
          <p class="text-3xl font-bold text-accent"><%= stats.totalGrades %></p>
          <div class="text-sm text-base-content/70">
            Students graded
          </div>
        </div>
      </div>

    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      
      <!-- Activity Trends Chart (Line/Area Chart) -->
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
          <h2 class="card-title text-xl mb-4">üìä Activity Trends (Last 30 Days)</h2>
          <div>
            <canvas id="activityTrendsChart" style="max-height: 300px;"></canvas>
          </div>
        </div>
      </div>

      <!-- Teacher Workload Distribution (Horizontal Bar Chart) -->
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
          <h2 class="card-title text-xl mb-4">üë®‚Äçüè´ Teacher Workload Distribution</h2>
          <div>
            <canvas id="teacherWorkloadChart" style="max-height: 300px;"></canvas>
          </div>
        </div>
      </div>

    </div>

    <!-- Alerts & Notifications and Resource Usage Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      
      <!-- Alerts & Notifications -->
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
          <h2 class="card-title text-xl mb-4">üö® Alerts & Notifications</h2>
          
          <!-- Inactive Teachers Alert -->
          <% if (alerts.inactiveTeachers && alerts.inactiveTeachers.length > 0) { %>
            <div class="alert alert-warning mb-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <div class="w-full">
                <h3 class="font-bold">Inactive Teachers (14+ days)</h3>
                <div class="text-sm mt-2">
                  <% alerts.inactiveTeachers.forEach(teacher => { %>
                    <div class="flex justify-between py-1 border-b border-base-300 last:border-b-0">
                      <span><%= teacher.full_name %></span>
                      <span class="text-xs opacity-70">
                        Last active: <%= Math.floor((Date.now() - new Date(teacher.updated_at)) / (1000 * 60 * 60 * 24)) %> days ago
                      </span>
                    </div>
                  <% }); %>
                </div>
              </div>
            </div>
          <% } else { %>
            <div class="alert alert-success">
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>All teachers are active! ‚ú®</span>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Resource Usage -->
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
          <h2 class="card-title text-xl mb-4">üíæ Resource Usage</h2>
          
          <!-- Total Files Uploaded -->
          <div class="mb-4">
            <div class="flex justify-between mb-2">
              <span class="text-sm font-semibold">üìÅ Total Files Uploaded</span>
              <span class="text-sm font-bold text-primary"><%= stats.totalFilesUploaded %> files</span>
            </div>
            <progress class="progress progress-primary w-full" value="<%= stats.totalFilesUploaded %>" max="1000"></progress>
            <div class="text-xs text-base-content/60 mt-1">
              <%= stats.totalFilesUploaded %> / 1000 files
            </div>
          </div>

          <!-- Storage Usage -->
          <div class="mb-4">
            <div class="flex justify-between mb-2">
              <span class="text-sm font-semibold">üíø Estimated Storage</span>
              <span class="text-sm font-bold text-secondary"><%= stats.estimatedStorageGB %> GB</span>
            </div>
            <progress class="progress progress-secondary w-full" value="<%= parseFloat(stats.estimatedStorageGB) %>" max="100"></progress>
            <div class="text-xs text-base-content/60 mt-1">
              <%= stats.estimatedStorageGB %> / 100 GB
            </div>
          </div>

          <!-- Additional Stats -->
          <div class="stats stats-vertical shadow w-full">
            <div class="stat py-2 px-4">
              <div class="stat-title text-xs">Course Materials</div>
              <div class="stat-value text-2xl text-accent"><%= stats.totalAssignments %></div>
            </div>
            <div class="stat py-2 px-4">
              <div class="stat-title text-xs">Student Submissions</div>
              <div class="stat-value text-2xl text-info"><%= stats.totalSubmissions %></div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Recent Activity -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      
      <!-- Recent Users -->
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
          <h2 class="card-title text-xl mb-4">üë• Recent Users</h2>
          <div class="overflow-x-auto">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Role</th>
                  <th>Joined</th>
                </tr>
              </thead>
              <tbody>
                <% if (recentActivity.users.length === 0) { %>
                  <tr>
                    <td colspan="3" class="text-center text-base-content/50">No users yet</td>
                  </tr>
                <% } else { %>
                  <% recentActivity.users.forEach(user => { %>
                    <tr>
                      <td><%= user.full_name %></td>
                      <td>
                        <span class="badge badge-sm 
                          <%= user.role === 'admin' ? 'badge-error' : 
                              user.role === 'teacher' ? 'badge-primary' : 
                              'badge-success' %>">
                          <%= user.role %>
                        </span>
                      </td>
                      <td>
                        <% if (user.created_at) { %>
                          <%= new Date(user.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %>
                        <% } else { %>
                          <span class="text-xs opacity-50">Before tracking</span>
                        <% } %>
                      </td>
                    </tr>
                  <% }); %>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Recent Submissions -->
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
          <h2 class="card-title text-xl mb-4">üì§ Recent Submissions</h2>
          <div class="overflow-x-auto">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Student</th>
                  <th>Assignment</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                <% if (recentActivity.submissions.length === 0) { %>
                  <tr>
                    <td colspan="3" class="text-center text-base-content/50">No submissions yet</td>
                  </tr>
                <% } else { %>
                  <% recentActivity.submissions.forEach(sub => { %>
                    <tr>
                      <td><%= sub.student ? sub.student.full_name : 'N/A' %></td>
                      <td><%= sub.assignment ? sub.assignment.title : 'N/A' %></td>
                      <td>
                        <% if (sub.submitted_at) { %>
                          <%= new Date(sub.submitted_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %>
                        <% } else { %>
                          N/A
                        <% } %>
                      </td>
                    </tr>
                  <% }); %>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>

    <!-- Quick Actions -->
    <div class="card bg-base-100 shadow-lg">
      <div class="card-body">
        <h2 class="card-title text-xl mb-4">‚ö° Quick Actions</h2>
        <div class="flex flex-wrap gap-3">
          <a href="/admin" class="btn btn-primary">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            AdminJS Panel
          </a>
          <a href="/admin/tools" class="btn btn-secondary">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
            </svg>
            Bulk Operations
          </a>
          <a href="/auth/change-password" class="btn btn-accent">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
            </svg>
            Change Password
          </a>
        </div>
      </div>
    </div>

  </div>

  <!-- Chart.js Configuration -->
  <script>
    // @ts-nocheck - EJS template syntax causes false TypeScript errors
    
    // ============================================
    // Activity Trends Line/Area Chart
    // ============================================
    const activityCtx = document.getElementById('activityTrendsChart');
    new Chart(activityCtx, {
      type: 'line',
      data: {
        labels: <%- JSON.stringify(charts.activityTrends.labels) %>,
        datasets: [
          {
            label: 'Submissions',
            data: <%- JSON.stringify(charts.activityTrends.submissions) %>,
            backgroundColor: 'rgba(59, 130, 246, 0.2)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          },
          {
            label: 'Grades Entered',
            data: <%- JSON.stringify(charts.activityTrends.grades) %>,
            backgroundColor: 'rgba(16, 185, 129, 0.2)',
            borderColor: 'rgba(16, 185, 129, 1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          },
          {
            label: 'User Logins',
            data: <%- JSON.stringify(charts.activityTrends.logins) %>,
            backgroundColor: 'rgba(245, 158, 11, 0.2)',
            borderColor: 'rgba(245, 158, 11, 1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          legend: {
            position: 'bottom'
          },
          tooltip: {
            mode: 'index',
            intersect: false,
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          },
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 45
            }
          }
        }
      }
    });

    // ============================================
    // Teacher Workload Horizontal Bar Chart
    // ============================================
    const workloadCtx = document.getElementById('teacherWorkloadChart');
    new Chart(workloadCtx, {
      type: 'bar',
      data: {
        labels: <%- JSON.stringify(charts.teacherWorkload.labels) %>,
        datasets: [
          {
            label: 'Assignments Created',
            data: <%- JSON.stringify(charts.teacherWorkload.assignmentsCreated) %>,
            backgroundColor: 'rgba(59, 130, 246, 0.8)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 1
          },
          {
            label: 'Courses Teaching',
            data: <%- JSON.stringify(charts.teacherWorkload.coursesTeaching) %>,
            backgroundColor: 'rgba(16, 185, 129, 0.8)',
            borderColor: 'rgba(16, 185, 129, 1)',
            borderWidth: 1
          },
          {
            label: 'Pending Grades',
            data: <%- JSON.stringify(charts.teacherWorkload.pendingGrades) %>,
            backgroundColor: 'rgba(239, 68, 68, 0.8)',
            borderColor: 'rgba(239, 68, 68, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'bottom'
          },
          tooltip: {
            mode: 'index',
            intersect: false,
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
  </script>

</body>
</html>
